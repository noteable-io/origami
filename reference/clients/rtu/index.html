
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A Python SDK for Noteable API interactions.">
      
      
      
      
        <link rel="prev" href="../cache/">
      
      
        <link rel="next" href="../../log_utils/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.8">
    
    
      
        <title>rtu - Origami</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.4b4a2bd9.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="cyan">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#clients.rtu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Origami" class="md-header__button md-logo" aria-label="Origami" data-md-component="logo">
      
  <img src="../../../papersnake-dark.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Origami
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              rtu
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="cyan" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="cyan" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/noteable-io/origami/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    noteable-io/origami
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Origami" class="md-nav__button md-logo" aria-label="Origami" data-md-component="logo">
      
  <img src="../../../papersnake-dark.svg" alt="logo">

    </a>
    Origami
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/noteable-io/origami/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    noteable-io/origami
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Use Cases
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Code Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cli
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    clients
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            clients
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    api
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cache
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    rtu
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    rtu
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#clients.rtu" class="md-nav__link">
    rtu
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clients.rtu.DeltaRequestCallbackManager" class="md-nav__link">
    DeltaRequestCallbackManager
  </a>
  
    <nav class="md-nav" aria-label="DeltaRequestCallbackManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clients.rtu.DeltaRequestCallbackManager--delta-is-guarenteed-to-be-in-rtu_clientbuilder-at-this-point" class="md-nav__link">
    Delta is guarenteed to be in rtu_client.builder at this point
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient" class="md-nav__link">
    RTUClient
  </a>
  
    <nav class="md-nav" aria-label="RTUClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.cell_ids" class="md-nav__link">
    cell_ids
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.kernel_pod_name" class="md-nav__link">
    kernel_pod_name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.add_cell" class="md-nav__link">
    add_cell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.apply_delta" class="md-nav__link">
    apply_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.auth_hook" class="md-nav__link">
    auth_hook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.catastrophic_failure" class="md-nav__link">
    catastrophic_failure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.change_cell_type" class="md-nav__link">
    change_cell_type()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.failed_to_squash_delta" class="md-nav__link">
    failed_to_squash_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.file_unsubscribe" class="md-nav__link">
    file_unsubscribe()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.load_seed_notebook" class="md-nav__link">
    load_seed_notebook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.new_delta_request" class="md-nav__link">
    new_delta_request()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_bulk_cell_state_update" class="md-nav__link">
    on_bulk_cell_state_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_file_subscribe_timeout" class="md-nav__link">
    on_file_subscribe_timeout()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_inconsistent_state_event" class="md-nav__link">
    on_inconsistent_state_event()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_kernel_status_update" class="md-nav__link">
    on_kernel_status_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.post_queue_delta" class="md-nav__link">
    post_queue_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.pre_apply_delta" class="md-nav__link">
    pre_apply_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.queue_execution" class="md-nav__link">
    queue_execution()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.queue_or_apply_delta" class="md-nav__link">
    queue_or_apply_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.register_delta_callback" class="md-nav__link">
    register_delta_callback()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.register_rtu_event_callback" class="md-nav__link">
    register_rtu_event_callback()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.register_transaction_id_callback" class="md-nav__link">
    register_transaction_id_callback()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.replace_cell_content" class="md-nav__link">
    replace_cell_content()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.replay_unapplied_deltas" class="md-nav__link">
    replay_unapplied_deltas()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.send" class="md-nav__link">
    send()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.send_file_subscribe" class="md-nav__link">
    send_file_subscribe()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.update_cell_content" class="md-nav__link">
    update_cell_content()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.wait_for_kernel_idle" class="md-nav__link">
    wait_for_kernel_idle()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager" class="md-nav__link">
    RTUManager
  </a>
  
    <nav class="md-nav" aria-label="RTUManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.inbound_message_hook" class="md-nav__link">
    inbound_message_hook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.on_exception" class="md-nav__link">
    on_exception()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.outbound_message_hook" class="md-nav__link">
    outbound_message_hook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.send" class="md-nav__link">
    send()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../log_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    log_utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_1" >
        
          
          <label class="md-nav__link" for="__nav_5_4_1" id="__nav_5_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    api
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_1">
            <span class="md-nav__icon md-icon"></span>
            api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/datasources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    datasources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/outputs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    outputs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    projects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/spaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    spaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/api/users/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    users
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_2" >
        
          
          <label class="md-nav__link" for="__nav_5_4_2" id="__nav_5_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    deltas
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_2">
            <span class="md-nav__icon md-icon"></span>
            deltas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_5_4_2_2" id="__nav_5_4_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    delta_types
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            delta_types
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/delta_types/cell_contents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cell_contents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/delta_types/cell_execute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cell_execute
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/delta_types/cell_metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cell_metadata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/delta_types/cell_output_collection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cell_output_collection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/delta_types/nb_cells/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nb_cells
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/delta_types/nb_metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nb_metadata
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/deltas/discriminators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    discriminators
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/kernels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kernels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/notebook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    notebook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_5" >
        
          
          <label class="md-nav__link" for="__nav_5_4_5" id="__nav_5_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    rtu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_5">
            <span class="md-nav__icon md-icon"></span>
            rtu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/rtu/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_4_5_2" id="__nav_5_4_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    channels
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_4_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4_5_2">
            <span class="md-nav__icon md-icon"></span>
            channels
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/rtu/channels/files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/rtu/channels/kernels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kernels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/rtu/channels/system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    system
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/rtu/discriminators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    discriminators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../models/rtu/errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    errors
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    notebook
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            notebook
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../notebook/builder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    builder
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Changes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Changes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Log
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#clients.rtu" class="md-nav__link">
    rtu
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clients.rtu.DeltaRequestCallbackManager" class="md-nav__link">
    DeltaRequestCallbackManager
  </a>
  
    <nav class="md-nav" aria-label="DeltaRequestCallbackManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clients.rtu.DeltaRequestCallbackManager--delta-is-guarenteed-to-be-in-rtu_clientbuilder-at-this-point" class="md-nav__link">
    Delta is guarenteed to be in rtu_client.builder at this point
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient" class="md-nav__link">
    RTUClient
  </a>
  
    <nav class="md-nav" aria-label="RTUClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.cell_ids" class="md-nav__link">
    cell_ids
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.kernel_pod_name" class="md-nav__link">
    kernel_pod_name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.add_cell" class="md-nav__link">
    add_cell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.apply_delta" class="md-nav__link">
    apply_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.auth_hook" class="md-nav__link">
    auth_hook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.catastrophic_failure" class="md-nav__link">
    catastrophic_failure()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.change_cell_type" class="md-nav__link">
    change_cell_type()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.failed_to_squash_delta" class="md-nav__link">
    failed_to_squash_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.file_unsubscribe" class="md-nav__link">
    file_unsubscribe()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.load_seed_notebook" class="md-nav__link">
    load_seed_notebook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.new_delta_request" class="md-nav__link">
    new_delta_request()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_bulk_cell_state_update" class="md-nav__link">
    on_bulk_cell_state_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_file_subscribe_timeout" class="md-nav__link">
    on_file_subscribe_timeout()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_inconsistent_state_event" class="md-nav__link">
    on_inconsistent_state_event()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.on_kernel_status_update" class="md-nav__link">
    on_kernel_status_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.post_queue_delta" class="md-nav__link">
    post_queue_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.pre_apply_delta" class="md-nav__link">
    pre_apply_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.queue_execution" class="md-nav__link">
    queue_execution()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.queue_or_apply_delta" class="md-nav__link">
    queue_or_apply_delta()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.register_delta_callback" class="md-nav__link">
    register_delta_callback()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.register_rtu_event_callback" class="md-nav__link">
    register_rtu_event_callback()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.register_transaction_id_callback" class="md-nav__link">
    register_transaction_id_callback()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.replace_cell_content" class="md-nav__link">
    replace_cell_content()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.replay_unapplied_deltas" class="md-nav__link">
    replay_unapplied_deltas()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.send" class="md-nav__link">
    send()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.send_file_subscribe" class="md-nav__link">
    send_file_subscribe()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.update_cell_content" class="md-nav__link">
    update_cell_content()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUClient.wait_for_kernel_idle" class="md-nav__link">
    wait_for_kernel_idle()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager" class="md-nav__link">
    RTUManager
  </a>
  
    <nav class="md-nav" aria-label="RTUManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.inbound_message_hook" class="md-nav__link">
    inbound_message_hook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.on_exception" class="md-nav__link">
    on_exception()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.outbound_message_hook" class="md-nav__link">
    outbound_message_hook()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clients.rtu.RTUManager.send" class="md-nav__link">
    send()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>rtu</h1>

<div class="doc doc-object doc-module">



<a id="clients.rtu"></a>
  <div class="doc doc-contents first">
  
      <p>RTUClient is a high-level client for establishing a websocket connection, authenticating with a jwt,
subscribing to a file by version or last delta id, "squashing" Deltas into an in-memory Notebook
model, and registering callbacks for incoming RTU events by event_name and channel or incoming
Deltas by delta type and delta action.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="clients.rtu.DeltaRequestCallbackManager" class="doc doc-heading">
          <code>DeltaRequestCallbackManager</code>


<a href="#clients.rtu.DeltaRequestCallbackManager" class="headerlink" title="Permanent link">#</a></h2>


  <div class="doc doc-contents ">

  
      <p>Don't use this directly, see RTUClient.new_delta_request which builds an instance of this and
returns the .result -- Future resolves to bool or raises DeltaRejected</p>
<ul>
<li>Sends over websocket to Gate</li>
<li>Registers RTU and Delta squashing callbacks to resolve the Future either when the Delta was
  successful and squashed into Notebook or when there was an error (Rejected / Invalid Delta)</li>
<li>Deregisters RTU and Delta callbacks when Future is resolved</li>
</ul>
<p>Use case:
delta_squashed: asyncio.Future[bool] = await rtu_client.new_delta_request(...)
try:
    await delta_squashed
except DeltaRejected:
    ...</p>
<h3 id="clients.rtu.DeltaRequestCallbackManager--delta-is-guarenteed-to-be-in-rtu_clientbuilder-at-this-point">Delta is guarenteed to be in rtu_client.builder at this point<a class="headerlink" href="#clients.rtu.DeltaRequestCallbackManager--delta-is-guarenteed-to-be-in-rtu_clientbuilder-at-this-point" title="Permanent link">#</a></h3>

            <details class="quote">
              <summary>Source code in <code>origami/clients/rtu.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="k">class</span> <span class="nc">DeltaRequestCallbackManager</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    Don&#39;t use this directly, see RTUClient.new_delta_request which builds an instance of this and</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">    returns the .result -- Future resolves to bool or raises DeltaRejected</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    - Sends over websocket to Gate</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    - Registers RTU and Delta squashing callbacks to resolve the Future either when the Delta was</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">      successful and squashed into Notebook or when there was an error (Rejected / Invalid Delta)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    - Deregisters RTU and Delta callbacks when Future is resolved</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Use case:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    delta_squashed: asyncio.Future[bool] = await rtu_client.new_delta_request(...)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    try:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        await delta_squashed</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    except DeltaRejected:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        ...</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    # Delta is guarenteed to be in rtu_client.builder at this point</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="s2">&quot;RTUClient&quot;</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>  <span class="c1"># keep a ref to use in self.delta_cb_ref</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">req</span> <span class="o">=</span> <span class="n">NewDeltaRequest</span><span class="p">(</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">NewDeltaRequestData</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Register one cb by RTU request transaction id in order to catch errors and set Future</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtu_cb_ref</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">register_transaction_id_callback</span><span class="p">(</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">transaction_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rtu_cb</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="c1"># Register other cb by Delta type so we&#39;ll be able to resolve future when it&#39;s squashed</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_cb_ref</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">register_delta_callback</span><span class="p">(</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">delta_class</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_cb</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">def</span> <span class="nf">deregister_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtu_cb_ref</span><span class="p">()</span>  <span class="c1"># deregisters the callback from Sending managed list</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_cb_ref</span><span class="p">)</span>  <span class="c1"># Remove from delta cb list</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">rtu_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="c1"># If the delta is rejected, we should see a new_delta_reply with success=False and the</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="c1"># details are in a separate delta_rejected event</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;delta_rejected&quot;</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Delta rejected&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rtu_msg&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">DeltaRejected</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cause&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">deregister_callbacks</span><span class="p">()</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;invalid_data&quot;</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="c1"># If Gate can&#39;t parse the Delta into Pydantic model, it will give back this invalid_data</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="c1"># event, but it doesn&#39;t include the validation details in the body. Need to look at</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="c1"># Gate logs to see what happened (like nb_cells add not having &#39;id&#39; in properties)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Delta invalid&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rtu_msg&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">DeltaRejected</span><span class="p">(</span><span class="s2">&quot;Invalid Delta scheme&quot;</span><span class="p">))</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">deregister_callbacks</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;permission_denied&quot;</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Delta permission denied&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rtu_msg&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">DeltaRejected</span><span class="p">(</span><span class="s2">&quot;Permission denied&quot;</span><span class="p">))</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">deregister_callbacks</span><span class="p">()</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">delta_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Delta squashed&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">delta</span><span class="p">})</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">deregister_callbacks</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="clients.rtu.RTUClient" class="doc doc-heading">
          <code>RTUClient</code>


<a href="#clients.rtu.RTUClient" class="headerlink" title="Permanent link">#</a></h2>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>origami/clients/rtu.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-231"> 231</a></span>
<span class="normal"><a href="#__codelineno-0-232"> 232</a></span>
<span class="normal"><a href="#__codelineno-0-233"> 233</a></span>
<span class="normal"><a href="#__codelineno-0-234"> 234</a></span>
<span class="normal"><a href="#__codelineno-0-235"> 235</a></span>
<span class="normal"><a href="#__codelineno-0-236"> 236</a></span>
<span class="normal"><a href="#__codelineno-0-237"> 237</a></span>
<span class="normal"><a href="#__codelineno-0-238"> 238</a></span>
<span class="normal"><a href="#__codelineno-0-239"> 239</a></span>
<span class="normal"><a href="#__codelineno-0-240"> 240</a></span>
<span class="normal"><a href="#__codelineno-0-241"> 241</a></span>
<span class="normal"><a href="#__codelineno-0-242"> 242</a></span>
<span class="normal"><a href="#__codelineno-0-243"> 243</a></span>
<span class="normal"><a href="#__codelineno-0-244"> 244</a></span>
<span class="normal"><a href="#__codelineno-0-245"> 245</a></span>
<span class="normal"><a href="#__codelineno-0-246"> 246</a></span>
<span class="normal"><a href="#__codelineno-0-247"> 247</a></span>
<span class="normal"><a href="#__codelineno-0-248"> 248</a></span>
<span class="normal"><a href="#__codelineno-0-249"> 249</a></span>
<span class="normal"><a href="#__codelineno-0-250"> 250</a></span>
<span class="normal"><a href="#__codelineno-0-251"> 251</a></span>
<span class="normal"><a href="#__codelineno-0-252"> 252</a></span>
<span class="normal"><a href="#__codelineno-0-253"> 253</a></span>
<span class="normal"><a href="#__codelineno-0-254"> 254</a></span>
<span class="normal"><a href="#__codelineno-0-255"> 255</a></span>
<span class="normal"><a href="#__codelineno-0-256"> 256</a></span>
<span class="normal"><a href="#__codelineno-0-257"> 257</a></span>
<span class="normal"><a href="#__codelineno-0-258"> 258</a></span>
<span class="normal"><a href="#__codelineno-0-259"> 259</a></span>
<span class="normal"><a href="#__codelineno-0-260"> 260</a></span>
<span class="normal"><a href="#__codelineno-0-261"> 261</a></span>
<span class="normal"><a href="#__codelineno-0-262"> 262</a></span>
<span class="normal"><a href="#__codelineno-0-263"> 263</a></span>
<span class="normal"><a href="#__codelineno-0-264"> 264</a></span>
<span class="normal"><a href="#__codelineno-0-265"> 265</a></span>
<span class="normal"><a href="#__codelineno-0-266"> 266</a></span>
<span class="normal"><a href="#__codelineno-0-267"> 267</a></span>
<span class="normal"><a href="#__codelineno-0-268"> 268</a></span>
<span class="normal"><a href="#__codelineno-0-269"> 269</a></span>
<span class="normal"><a href="#__codelineno-0-270"> 270</a></span>
<span class="normal"><a href="#__codelineno-0-271"> 271</a></span>
<span class="normal"><a href="#__codelineno-0-272"> 272</a></span>
<span class="normal"><a href="#__codelineno-0-273"> 273</a></span>
<span class="normal"><a href="#__codelineno-0-274"> 274</a></span>
<span class="normal"><a href="#__codelineno-0-275"> 275</a></span>
<span class="normal"><a href="#__codelineno-0-276"> 276</a></span>
<span class="normal"><a href="#__codelineno-0-277"> 277</a></span>
<span class="normal"><a href="#__codelineno-0-278"> 278</a></span>
<span class="normal"><a href="#__codelineno-0-279"> 279</a></span>
<span class="normal"><a href="#__codelineno-0-280"> 280</a></span>
<span class="normal"><a href="#__codelineno-0-281"> 281</a></span>
<span class="normal"><a href="#__codelineno-0-282"> 282</a></span>
<span class="normal"><a href="#__codelineno-0-283"> 283</a></span>
<span class="normal"><a href="#__codelineno-0-284"> 284</a></span>
<span class="normal"><a href="#__codelineno-0-285"> 285</a></span>
<span class="normal"><a href="#__codelineno-0-286"> 286</a></span>
<span class="normal"><a href="#__codelineno-0-287"> 287</a></span>
<span class="normal"><a href="#__codelineno-0-288"> 288</a></span>
<span class="normal"><a href="#__codelineno-0-289"> 289</a></span>
<span class="normal"><a href="#__codelineno-0-290"> 290</a></span>
<span class="normal"><a href="#__codelineno-0-291"> 291</a></span>
<span class="normal"><a href="#__codelineno-0-292"> 292</a></span>
<span class="normal"><a href="#__codelineno-0-293"> 293</a></span>
<span class="normal"><a href="#__codelineno-0-294"> 294</a></span>
<span class="normal"><a href="#__codelineno-0-295"> 295</a></span>
<span class="normal"><a href="#__codelineno-0-296"> 296</a></span>
<span class="normal"><a href="#__codelineno-0-297"> 297</a></span>
<span class="normal"><a href="#__codelineno-0-298"> 298</a></span>
<span class="normal"><a href="#__codelineno-0-299"> 299</a></span>
<span class="normal"><a href="#__codelineno-0-300"> 300</a></span>
<span class="normal"><a href="#__codelineno-0-301"> 301</a></span>
<span class="normal"><a href="#__codelineno-0-302"> 302</a></span>
<span class="normal"><a href="#__codelineno-0-303"> 303</a></span>
<span class="normal"><a href="#__codelineno-0-304"> 304</a></span>
<span class="normal"><a href="#__codelineno-0-305"> 305</a></span>
<span class="normal"><a href="#__codelineno-0-306"> 306</a></span>
<span class="normal"><a href="#__codelineno-0-307"> 307</a></span>
<span class="normal"><a href="#__codelineno-0-308"> 308</a></span>
<span class="normal"><a href="#__codelineno-0-309"> 309</a></span>
<span class="normal"><a href="#__codelineno-0-310"> 310</a></span>
<span class="normal"><a href="#__codelineno-0-311"> 311</a></span>
<span class="normal"><a href="#__codelineno-0-312"> 312</a></span>
<span class="normal"><a href="#__codelineno-0-313"> 313</a></span>
<span class="normal"><a href="#__codelineno-0-314"> 314</a></span>
<span class="normal"><a href="#__codelineno-0-315"> 315</a></span>
<span class="normal"><a href="#__codelineno-0-316"> 316</a></span>
<span class="normal"><a href="#__codelineno-0-317"> 317</a></span>
<span class="normal"><a href="#__codelineno-0-318"> 318</a></span>
<span class="normal"><a href="#__codelineno-0-319"> 319</a></span>
<span class="normal"><a href="#__codelineno-0-320"> 320</a></span>
<span class="normal"><a href="#__codelineno-0-321"> 321</a></span>
<span class="normal"><a href="#__codelineno-0-322"> 322</a></span>
<span class="normal"><a href="#__codelineno-0-323"> 323</a></span>
<span class="normal"><a href="#__codelineno-0-324"> 324</a></span>
<span class="normal"><a href="#__codelineno-0-325"> 325</a></span>
<span class="normal"><a href="#__codelineno-0-326"> 326</a></span>
<span class="normal"><a href="#__codelineno-0-327"> 327</a></span>
<span class="normal"><a href="#__codelineno-0-328"> 328</a></span>
<span class="normal"><a href="#__codelineno-0-329"> 329</a></span>
<span class="normal"><a href="#__codelineno-0-330"> 330</a></span>
<span class="normal"><a href="#__codelineno-0-331"> 331</a></span>
<span class="normal"><a href="#__codelineno-0-332"> 332</a></span>
<span class="normal"><a href="#__codelineno-0-333"> 333</a></span>
<span class="normal"><a href="#__codelineno-0-334"> 334</a></span>
<span class="normal"><a href="#__codelineno-0-335"> 335</a></span>
<span class="normal"><a href="#__codelineno-0-336"> 336</a></span>
<span class="normal"><a href="#__codelineno-0-337"> 337</a></span>
<span class="normal"><a href="#__codelineno-0-338"> 338</a></span>
<span class="normal"><a href="#__codelineno-0-339"> 339</a></span>
<span class="normal"><a href="#__codelineno-0-340"> 340</a></span>
<span class="normal"><a href="#__codelineno-0-341"> 341</a></span>
<span class="normal"><a href="#__codelineno-0-342"> 342</a></span>
<span class="normal"><a href="#__codelineno-0-343"> 343</a></span>
<span class="normal"><a href="#__codelineno-0-344"> 344</a></span>
<span class="normal"><a href="#__codelineno-0-345"> 345</a></span>
<span class="normal"><a href="#__codelineno-0-346"> 346</a></span>
<span class="normal"><a href="#__codelineno-0-347"> 347</a></span>
<span class="normal"><a href="#__codelineno-0-348"> 348</a></span>
<span class="normal"><a href="#__codelineno-0-349"> 349</a></span>
<span class="normal"><a href="#__codelineno-0-350"> 350</a></span>
<span class="normal"><a href="#__codelineno-0-351"> 351</a></span>
<span class="normal"><a href="#__codelineno-0-352"> 352</a></span>
<span class="normal"><a href="#__codelineno-0-353"> 353</a></span>
<span class="normal"><a href="#__codelineno-0-354"> 354</a></span>
<span class="normal"><a href="#__codelineno-0-355"> 355</a></span>
<span class="normal"><a href="#__codelineno-0-356"> 356</a></span>
<span class="normal"><a href="#__codelineno-0-357"> 357</a></span>
<span class="normal"><a href="#__codelineno-0-358"> 358</a></span>
<span class="normal"><a href="#__codelineno-0-359"> 359</a></span>
<span class="normal"><a href="#__codelineno-0-360"> 360</a></span>
<span class="normal"><a href="#__codelineno-0-361"> 361</a></span>
<span class="normal"><a href="#__codelineno-0-362"> 362</a></span>
<span class="normal"><a href="#__codelineno-0-363"> 363</a></span>
<span class="normal"><a href="#__codelineno-0-364"> 364</a></span>
<span class="normal"><a href="#__codelineno-0-365"> 365</a></span>
<span class="normal"><a href="#__codelineno-0-366"> 366</a></span>
<span class="normal"><a href="#__codelineno-0-367"> 367</a></span>
<span class="normal"><a href="#__codelineno-0-368"> 368</a></span>
<span class="normal"><a href="#__codelineno-0-369"> 369</a></span>
<span class="normal"><a href="#__codelineno-0-370"> 370</a></span>
<span class="normal"><a href="#__codelineno-0-371"> 371</a></span>
<span class="normal"><a href="#__codelineno-0-372"> 372</a></span>
<span class="normal"><a href="#__codelineno-0-373"> 373</a></span>
<span class="normal"><a href="#__codelineno-0-374"> 374</a></span>
<span class="normal"><a href="#__codelineno-0-375"> 375</a></span>
<span class="normal"><a href="#__codelineno-0-376"> 376</a></span>
<span class="normal"><a href="#__codelineno-0-377"> 377</a></span>
<span class="normal"><a href="#__codelineno-0-378"> 378</a></span>
<span class="normal"><a href="#__codelineno-0-379"> 379</a></span>
<span class="normal"><a href="#__codelineno-0-380"> 380</a></span>
<span class="normal"><a href="#__codelineno-0-381"> 381</a></span>
<span class="normal"><a href="#__codelineno-0-382"> 382</a></span>
<span class="normal"><a href="#__codelineno-0-383"> 383</a></span>
<span class="normal"><a href="#__codelineno-0-384"> 384</a></span>
<span class="normal"><a href="#__codelineno-0-385"> 385</a></span>
<span class="normal"><a href="#__codelineno-0-386"> 386</a></span>
<span class="normal"><a href="#__codelineno-0-387"> 387</a></span>
<span class="normal"><a href="#__codelineno-0-388"> 388</a></span>
<span class="normal"><a href="#__codelineno-0-389"> 389</a></span>
<span class="normal"><a href="#__codelineno-0-390"> 390</a></span>
<span class="normal"><a href="#__codelineno-0-391"> 391</a></span>
<span class="normal"><a href="#__codelineno-0-392"> 392</a></span>
<span class="normal"><a href="#__codelineno-0-393"> 393</a></span>
<span class="normal"><a href="#__codelineno-0-394"> 394</a></span>
<span class="normal"><a href="#__codelineno-0-395"> 395</a></span>
<span class="normal"><a href="#__codelineno-0-396"> 396</a></span>
<span class="normal"><a href="#__codelineno-0-397"> 397</a></span>
<span class="normal"><a href="#__codelineno-0-398"> 398</a></span>
<span class="normal"><a href="#__codelineno-0-399"> 399</a></span>
<span class="normal"><a href="#__codelineno-0-400"> 400</a></span>
<span class="normal"><a href="#__codelineno-0-401"> 401</a></span>
<span class="normal"><a href="#__codelineno-0-402"> 402</a></span>
<span class="normal"><a href="#__codelineno-0-403"> 403</a></span>
<span class="normal"><a href="#__codelineno-0-404"> 404</a></span>
<span class="normal"><a href="#__codelineno-0-405"> 405</a></span>
<span class="normal"><a href="#__codelineno-0-406"> 406</a></span>
<span class="normal"><a href="#__codelineno-0-407"> 407</a></span>
<span class="normal"><a href="#__codelineno-0-408"> 408</a></span>
<span class="normal"><a href="#__codelineno-0-409"> 409</a></span>
<span class="normal"><a href="#__codelineno-0-410"> 410</a></span>
<span class="normal"><a href="#__codelineno-0-411"> 411</a></span>
<span class="normal"><a href="#__codelineno-0-412"> 412</a></span>
<span class="normal"><a href="#__codelineno-0-413"> 413</a></span>
<span class="normal"><a href="#__codelineno-0-414"> 414</a></span>
<span class="normal"><a href="#__codelineno-0-415"> 415</a></span>
<span class="normal"><a href="#__codelineno-0-416"> 416</a></span>
<span class="normal"><a href="#__codelineno-0-417"> 417</a></span>
<span class="normal"><a href="#__codelineno-0-418"> 418</a></span>
<span class="normal"><a href="#__codelineno-0-419"> 419</a></span>
<span class="normal"><a href="#__codelineno-0-420"> 420</a></span>
<span class="normal"><a href="#__codelineno-0-421"> 421</a></span>
<span class="normal"><a href="#__codelineno-0-422"> 422</a></span>
<span class="normal"><a href="#__codelineno-0-423"> 423</a></span>
<span class="normal"><a href="#__codelineno-0-424"> 424</a></span>
<span class="normal"><a href="#__codelineno-0-425"> 425</a></span>
<span class="normal"><a href="#__codelineno-0-426"> 426</a></span>
<span class="normal"><a href="#__codelineno-0-427"> 427</a></span>
<span class="normal"><a href="#__codelineno-0-428"> 428</a></span>
<span class="normal"><a href="#__codelineno-0-429"> 429</a></span>
<span class="normal"><a href="#__codelineno-0-430"> 430</a></span>
<span class="normal"><a href="#__codelineno-0-431"> 431</a></span>
<span class="normal"><a href="#__codelineno-0-432"> 432</a></span>
<span class="normal"><a href="#__codelineno-0-433"> 433</a></span>
<span class="normal"><a href="#__codelineno-0-434"> 434</a></span>
<span class="normal"><a href="#__codelineno-0-435"> 435</a></span>
<span class="normal"><a href="#__codelineno-0-436"> 436</a></span>
<span class="normal"><a href="#__codelineno-0-437"> 437</a></span>
<span class="normal"><a href="#__codelineno-0-438"> 438</a></span>
<span class="normal"><a href="#__codelineno-0-439"> 439</a></span>
<span class="normal"><a href="#__codelineno-0-440"> 440</a></span>
<span class="normal"><a href="#__codelineno-0-441"> 441</a></span>
<span class="normal"><a href="#__codelineno-0-442"> 442</a></span>
<span class="normal"><a href="#__codelineno-0-443"> 443</a></span>
<span class="normal"><a href="#__codelineno-0-444"> 444</a></span>
<span class="normal"><a href="#__codelineno-0-445"> 445</a></span>
<span class="normal"><a href="#__codelineno-0-446"> 446</a></span>
<span class="normal"><a href="#__codelineno-0-447"> 447</a></span>
<span class="normal"><a href="#__codelineno-0-448"> 448</a></span>
<span class="normal"><a href="#__codelineno-0-449"> 449</a></span>
<span class="normal"><a href="#__codelineno-0-450"> 450</a></span>
<span class="normal"><a href="#__codelineno-0-451"> 451</a></span>
<span class="normal"><a href="#__codelineno-0-452"> 452</a></span>
<span class="normal"><a href="#__codelineno-0-453"> 453</a></span>
<span class="normal"><a href="#__codelineno-0-454"> 454</a></span>
<span class="normal"><a href="#__codelineno-0-455"> 455</a></span>
<span class="normal"><a href="#__codelineno-0-456"> 456</a></span>
<span class="normal"><a href="#__codelineno-0-457"> 457</a></span>
<span class="normal"><a href="#__codelineno-0-458"> 458</a></span>
<span class="normal"><a href="#__codelineno-0-459"> 459</a></span>
<span class="normal"><a href="#__codelineno-0-460"> 460</a></span>
<span class="normal"><a href="#__codelineno-0-461"> 461</a></span>
<span class="normal"><a href="#__codelineno-0-462"> 462</a></span>
<span class="normal"><a href="#__codelineno-0-463"> 463</a></span>
<span class="normal"><a href="#__codelineno-0-464"> 464</a></span>
<span class="normal"><a href="#__codelineno-0-465"> 465</a></span>
<span class="normal"><a href="#__codelineno-0-466"> 466</a></span>
<span class="normal"><a href="#__codelineno-0-467"> 467</a></span>
<span class="normal"><a href="#__codelineno-0-468"> 468</a></span>
<span class="normal"><a href="#__codelineno-0-469"> 469</a></span>
<span class="normal"><a href="#__codelineno-0-470"> 470</a></span>
<span class="normal"><a href="#__codelineno-0-471"> 471</a></span>
<span class="normal"><a href="#__codelineno-0-472"> 472</a></span>
<span class="normal"><a href="#__codelineno-0-473"> 473</a></span>
<span class="normal"><a href="#__codelineno-0-474"> 474</a></span>
<span class="normal"><a href="#__codelineno-0-475"> 475</a></span>
<span class="normal"><a href="#__codelineno-0-476"> 476</a></span>
<span class="normal"><a href="#__codelineno-0-477"> 477</a></span>
<span class="normal"><a href="#__codelineno-0-478"> 478</a></span>
<span class="normal"><a href="#__codelineno-0-479"> 479</a></span>
<span class="normal"><a href="#__codelineno-0-480"> 480</a></span>
<span class="normal"><a href="#__codelineno-0-481"> 481</a></span>
<span class="normal"><a href="#__codelineno-0-482"> 482</a></span>
<span class="normal"><a href="#__codelineno-0-483"> 483</a></span>
<span class="normal"><a href="#__codelineno-0-484"> 484</a></span>
<span class="normal"><a href="#__codelineno-0-485"> 485</a></span>
<span class="normal"><a href="#__codelineno-0-486"> 486</a></span>
<span class="normal"><a href="#__codelineno-0-487"> 487</a></span>
<span class="normal"><a href="#__codelineno-0-488"> 488</a></span>
<span class="normal"><a href="#__codelineno-0-489"> 489</a></span>
<span class="normal"><a href="#__codelineno-0-490"> 490</a></span>
<span class="normal"><a href="#__codelineno-0-491"> 491</a></span>
<span class="normal"><a href="#__codelineno-0-492"> 492</a></span>
<span class="normal"><a href="#__codelineno-0-493"> 493</a></span>
<span class="normal"><a href="#__codelineno-0-494"> 494</a></span>
<span class="normal"><a href="#__codelineno-0-495"> 495</a></span>
<span class="normal"><a href="#__codelineno-0-496"> 496</a></span>
<span class="normal"><a href="#__codelineno-0-497"> 497</a></span>
<span class="normal"><a href="#__codelineno-0-498"> 498</a></span>
<span class="normal"><a href="#__codelineno-0-499"> 499</a></span>
<span class="normal"><a href="#__codelineno-0-500"> 500</a></span>
<span class="normal"><a href="#__codelineno-0-501"> 501</a></span>
<span class="normal"><a href="#__codelineno-0-502"> 502</a></span>
<span class="normal"><a href="#__codelineno-0-503"> 503</a></span>
<span class="normal"><a href="#__codelineno-0-504"> 504</a></span>
<span class="normal"><a href="#__codelineno-0-505"> 505</a></span>
<span class="normal"><a href="#__codelineno-0-506"> 506</a></span>
<span class="normal"><a href="#__codelineno-0-507"> 507</a></span>
<span class="normal"><a href="#__codelineno-0-508"> 508</a></span>
<span class="normal"><a href="#__codelineno-0-509"> 509</a></span>
<span class="normal"><a href="#__codelineno-0-510"> 510</a></span>
<span class="normal"><a href="#__codelineno-0-511"> 511</a></span>
<span class="normal"><a href="#__codelineno-0-512"> 512</a></span>
<span class="normal"><a href="#__codelineno-0-513"> 513</a></span>
<span class="normal"><a href="#__codelineno-0-514"> 514</a></span>
<span class="normal"><a href="#__codelineno-0-515"> 515</a></span>
<span class="normal"><a href="#__codelineno-0-516"> 516</a></span>
<span class="normal"><a href="#__codelineno-0-517"> 517</a></span>
<span class="normal"><a href="#__codelineno-0-518"> 518</a></span>
<span class="normal"><a href="#__codelineno-0-519"> 519</a></span>
<span class="normal"><a href="#__codelineno-0-520"> 520</a></span>
<span class="normal"><a href="#__codelineno-0-521"> 521</a></span>
<span class="normal"><a href="#__codelineno-0-522"> 522</a></span>
<span class="normal"><a href="#__codelineno-0-523"> 523</a></span>
<span class="normal"><a href="#__codelineno-0-524"> 524</a></span>
<span class="normal"><a href="#__codelineno-0-525"> 525</a></span>
<span class="normal"><a href="#__codelineno-0-526"> 526</a></span>
<span class="normal"><a href="#__codelineno-0-527"> 527</a></span>
<span class="normal"><a href="#__codelineno-0-528"> 528</a></span>
<span class="normal"><a href="#__codelineno-0-529"> 529</a></span>
<span class="normal"><a href="#__codelineno-0-530"> 530</a></span>
<span class="normal"><a href="#__codelineno-0-531"> 531</a></span>
<span class="normal"><a href="#__codelineno-0-532"> 532</a></span>
<span class="normal"><a href="#__codelineno-0-533"> 533</a></span>
<span class="normal"><a href="#__codelineno-0-534"> 534</a></span>
<span class="normal"><a href="#__codelineno-0-535"> 535</a></span>
<span class="normal"><a href="#__codelineno-0-536"> 536</a></span>
<span class="normal"><a href="#__codelineno-0-537"> 537</a></span>
<span class="normal"><a href="#__codelineno-0-538"> 538</a></span>
<span class="normal"><a href="#__codelineno-0-539"> 539</a></span>
<span class="normal"><a href="#__codelineno-0-540"> 540</a></span>
<span class="normal"><a href="#__codelineno-0-541"> 541</a></span>
<span class="normal"><a href="#__codelineno-0-542"> 542</a></span>
<span class="normal"><a href="#__codelineno-0-543"> 543</a></span>
<span class="normal"><a href="#__codelineno-0-544"> 544</a></span>
<span class="normal"><a href="#__codelineno-0-545"> 545</a></span>
<span class="normal"><a href="#__codelineno-0-546"> 546</a></span>
<span class="normal"><a href="#__codelineno-0-547"> 547</a></span>
<span class="normal"><a href="#__codelineno-0-548"> 548</a></span>
<span class="normal"><a href="#__codelineno-0-549"> 549</a></span>
<span class="normal"><a href="#__codelineno-0-550"> 550</a></span>
<span class="normal"><a href="#__codelineno-0-551"> 551</a></span>
<span class="normal"><a href="#__codelineno-0-552"> 552</a></span>
<span class="normal"><a href="#__codelineno-0-553"> 553</a></span>
<span class="normal"><a href="#__codelineno-0-554"> 554</a></span>
<span class="normal"><a href="#__codelineno-0-555"> 555</a></span>
<span class="normal"><a href="#__codelineno-0-556"> 556</a></span>
<span class="normal"><a href="#__codelineno-0-557"> 557</a></span>
<span class="normal"><a href="#__codelineno-0-558"> 558</a></span>
<span class="normal"><a href="#__codelineno-0-559"> 559</a></span>
<span class="normal"><a href="#__codelineno-0-560"> 560</a></span>
<span class="normal"><a href="#__codelineno-0-561"> 561</a></span>
<span class="normal"><a href="#__codelineno-0-562"> 562</a></span>
<span class="normal"><a href="#__codelineno-0-563"> 563</a></span>
<span class="normal"><a href="#__codelineno-0-564"> 564</a></span>
<span class="normal"><a href="#__codelineno-0-565"> 565</a></span>
<span class="normal"><a href="#__codelineno-0-566"> 566</a></span>
<span class="normal"><a href="#__codelineno-0-567"> 567</a></span>
<span class="normal"><a href="#__codelineno-0-568"> 568</a></span>
<span class="normal"><a href="#__codelineno-0-569"> 569</a></span>
<span class="normal"><a href="#__codelineno-0-570"> 570</a></span>
<span class="normal"><a href="#__codelineno-0-571"> 571</a></span>
<span class="normal"><a href="#__codelineno-0-572"> 572</a></span>
<span class="normal"><a href="#__codelineno-0-573"> 573</a></span>
<span class="normal"><a href="#__codelineno-0-574"> 574</a></span>
<span class="normal"><a href="#__codelineno-0-575"> 575</a></span>
<span class="normal"><a href="#__codelineno-0-576"> 576</a></span>
<span class="normal"><a href="#__codelineno-0-577"> 577</a></span>
<span class="normal"><a href="#__codelineno-0-578"> 578</a></span>
<span class="normal"><a href="#__codelineno-0-579"> 579</a></span>
<span class="normal"><a href="#__codelineno-0-580"> 580</a></span>
<span class="normal"><a href="#__codelineno-0-581"> 581</a></span>
<span class="normal"><a href="#__codelineno-0-582"> 582</a></span>
<span class="normal"><a href="#__codelineno-0-583"> 583</a></span>
<span class="normal"><a href="#__codelineno-0-584"> 584</a></span>
<span class="normal"><a href="#__codelineno-0-585"> 585</a></span>
<span class="normal"><a href="#__codelineno-0-586"> 586</a></span>
<span class="normal"><a href="#__codelineno-0-587"> 587</a></span>
<span class="normal"><a href="#__codelineno-0-588"> 588</a></span>
<span class="normal"><a href="#__codelineno-0-589"> 589</a></span>
<span class="normal"><a href="#__codelineno-0-590"> 590</a></span>
<span class="normal"><a href="#__codelineno-0-591"> 591</a></span>
<span class="normal"><a href="#__codelineno-0-592"> 592</a></span>
<span class="normal"><a href="#__codelineno-0-593"> 593</a></span>
<span class="normal"><a href="#__codelineno-0-594"> 594</a></span>
<span class="normal"><a href="#__codelineno-0-595"> 595</a></span>
<span class="normal"><a href="#__codelineno-0-596"> 596</a></span>
<span class="normal"><a href="#__codelineno-0-597"> 597</a></span>
<span class="normal"><a href="#__codelineno-0-598"> 598</a></span>
<span class="normal"><a href="#__codelineno-0-599"> 599</a></span>
<span class="normal"><a href="#__codelineno-0-600"> 600</a></span>
<span class="normal"><a href="#__codelineno-0-601"> 601</a></span>
<span class="normal"><a href="#__codelineno-0-602"> 602</a></span>
<span class="normal"><a href="#__codelineno-0-603"> 603</a></span>
<span class="normal"><a href="#__codelineno-0-604"> 604</a></span>
<span class="normal"><a href="#__codelineno-0-605"> 605</a></span>
<span class="normal"><a href="#__codelineno-0-606"> 606</a></span>
<span class="normal"><a href="#__codelineno-0-607"> 607</a></span>
<span class="normal"><a href="#__codelineno-0-608"> 608</a></span>
<span class="normal"><a href="#__codelineno-0-609"> 609</a></span>
<span class="normal"><a href="#__codelineno-0-610"> 610</a></span>
<span class="normal"><a href="#__codelineno-0-611"> 611</a></span>
<span class="normal"><a href="#__codelineno-0-612"> 612</a></span>
<span class="normal"><a href="#__codelineno-0-613"> 613</a></span>
<span class="normal"><a href="#__codelineno-0-614"> 614</a></span>
<span class="normal"><a href="#__codelineno-0-615"> 615</a></span>
<span class="normal"><a href="#__codelineno-0-616"> 616</a></span>
<span class="normal"><a href="#__codelineno-0-617"> 617</a></span>
<span class="normal"><a href="#__codelineno-0-618"> 618</a></span>
<span class="normal"><a href="#__codelineno-0-619"> 619</a></span>
<span class="normal"><a href="#__codelineno-0-620"> 620</a></span>
<span class="normal"><a href="#__codelineno-0-621"> 621</a></span>
<span class="normal"><a href="#__codelineno-0-622"> 622</a></span>
<span class="normal"><a href="#__codelineno-0-623"> 623</a></span>
<span class="normal"><a href="#__codelineno-0-624"> 624</a></span>
<span class="normal"><a href="#__codelineno-0-625"> 625</a></span>
<span class="normal"><a href="#__codelineno-0-626"> 626</a></span>
<span class="normal"><a href="#__codelineno-0-627"> 627</a></span>
<span class="normal"><a href="#__codelineno-0-628"> 628</a></span>
<span class="normal"><a href="#__codelineno-0-629"> 629</a></span>
<span class="normal"><a href="#__codelineno-0-630"> 630</a></span>
<span class="normal"><a href="#__codelineno-0-631"> 631</a></span>
<span class="normal"><a href="#__codelineno-0-632"> 632</a></span>
<span class="normal"><a href="#__codelineno-0-633"> 633</a></span>
<span class="normal"><a href="#__codelineno-0-634"> 634</a></span>
<span class="normal"><a href="#__codelineno-0-635"> 635</a></span>
<span class="normal"><a href="#__codelineno-0-636"> 636</a></span>
<span class="normal"><a href="#__codelineno-0-637"> 637</a></span>
<span class="normal"><a href="#__codelineno-0-638"> 638</a></span>
<span class="normal"><a href="#__codelineno-0-639"> 639</a></span>
<span class="normal"><a href="#__codelineno-0-640"> 640</a></span>
<span class="normal"><a href="#__codelineno-0-641"> 641</a></span>
<span class="normal"><a href="#__codelineno-0-642"> 642</a></span>
<span class="normal"><a href="#__codelineno-0-643"> 643</a></span>
<span class="normal"><a href="#__codelineno-0-644"> 644</a></span>
<span class="normal"><a href="#__codelineno-0-645"> 645</a></span>
<span class="normal"><a href="#__codelineno-0-646"> 646</a></span>
<span class="normal"><a href="#__codelineno-0-647"> 647</a></span>
<span class="normal"><a href="#__codelineno-0-648"> 648</a></span>
<span class="normal"><a href="#__codelineno-0-649"> 649</a></span>
<span class="normal"><a href="#__codelineno-0-650"> 650</a></span>
<span class="normal"><a href="#__codelineno-0-651"> 651</a></span>
<span class="normal"><a href="#__codelineno-0-652"> 652</a></span>
<span class="normal"><a href="#__codelineno-0-653"> 653</a></span>
<span class="normal"><a href="#__codelineno-0-654"> 654</a></span>
<span class="normal"><a href="#__codelineno-0-655"> 655</a></span>
<span class="normal"><a href="#__codelineno-0-656"> 656</a></span>
<span class="normal"><a href="#__codelineno-0-657"> 657</a></span>
<span class="normal"><a href="#__codelineno-0-658"> 658</a></span>
<span class="normal"><a href="#__codelineno-0-659"> 659</a></span>
<span class="normal"><a href="#__codelineno-0-660"> 660</a></span>
<span class="normal"><a href="#__codelineno-0-661"> 661</a></span>
<span class="normal"><a href="#__codelineno-0-662"> 662</a></span>
<span class="normal"><a href="#__codelineno-0-663"> 663</a></span>
<span class="normal"><a href="#__codelineno-0-664"> 664</a></span>
<span class="normal"><a href="#__codelineno-0-665"> 665</a></span>
<span class="normal"><a href="#__codelineno-0-666"> 666</a></span>
<span class="normal"><a href="#__codelineno-0-667"> 667</a></span>
<span class="normal"><a href="#__codelineno-0-668"> 668</a></span>
<span class="normal"><a href="#__codelineno-0-669"> 669</a></span>
<span class="normal"><a href="#__codelineno-0-670"> 670</a></span>
<span class="normal"><a href="#__codelineno-0-671"> 671</a></span>
<span class="normal"><a href="#__codelineno-0-672"> 672</a></span>
<span class="normal"><a href="#__codelineno-0-673"> 673</a></span>
<span class="normal"><a href="#__codelineno-0-674"> 674</a></span>
<span class="normal"><a href="#__codelineno-0-675"> 675</a></span>
<span class="normal"><a href="#__codelineno-0-676"> 676</a></span>
<span class="normal"><a href="#__codelineno-0-677"> 677</a></span>
<span class="normal"><a href="#__codelineno-0-678"> 678</a></span>
<span class="normal"><a href="#__codelineno-0-679"> 679</a></span>
<span class="normal"><a href="#__codelineno-0-680"> 680</a></span>
<span class="normal"><a href="#__codelineno-0-681"> 681</a></span>
<span class="normal"><a href="#__codelineno-0-682"> 682</a></span>
<span class="normal"><a href="#__codelineno-0-683"> 683</a></span>
<span class="normal"><a href="#__codelineno-0-684"> 684</a></span>
<span class="normal"><a href="#__codelineno-0-685"> 685</a></span>
<span class="normal"><a href="#__codelineno-0-686"> 686</a></span>
<span class="normal"><a href="#__codelineno-0-687"> 687</a></span>
<span class="normal"><a href="#__codelineno-0-688"> 688</a></span>
<span class="normal"><a href="#__codelineno-0-689"> 689</a></span>
<span class="normal"><a href="#__codelineno-0-690"> 690</a></span>
<span class="normal"><a href="#__codelineno-0-691"> 691</a></span>
<span class="normal"><a href="#__codelineno-0-692"> 692</a></span>
<span class="normal"><a href="#__codelineno-0-693"> 693</a></span>
<span class="normal"><a href="#__codelineno-0-694"> 694</a></span>
<span class="normal"><a href="#__codelineno-0-695"> 695</a></span>
<span class="normal"><a href="#__codelineno-0-696"> 696</a></span>
<span class="normal"><a href="#__codelineno-0-697"> 697</a></span>
<span class="normal"><a href="#__codelineno-0-698"> 698</a></span>
<span class="normal"><a href="#__codelineno-0-699"> 699</a></span>
<span class="normal"><a href="#__codelineno-0-700"> 700</a></span>
<span class="normal"><a href="#__codelineno-0-701"> 701</a></span>
<span class="normal"><a href="#__codelineno-0-702"> 702</a></span>
<span class="normal"><a href="#__codelineno-0-703"> 703</a></span>
<span class="normal"><a href="#__codelineno-0-704"> 704</a></span>
<span class="normal"><a href="#__codelineno-0-705"> 705</a></span>
<span class="normal"><a href="#__codelineno-0-706"> 706</a></span>
<span class="normal"><a href="#__codelineno-0-707"> 707</a></span>
<span class="normal"><a href="#__codelineno-0-708"> 708</a></span>
<span class="normal"><a href="#__codelineno-0-709"> 709</a></span>
<span class="normal"><a href="#__codelineno-0-710"> 710</a></span>
<span class="normal"><a href="#__codelineno-0-711"> 711</a></span>
<span class="normal"><a href="#__codelineno-0-712"> 712</a></span>
<span class="normal"><a href="#__codelineno-0-713"> 713</a></span>
<span class="normal"><a href="#__codelineno-0-714"> 714</a></span>
<span class="normal"><a href="#__codelineno-0-715"> 715</a></span>
<span class="normal"><a href="#__codelineno-0-716"> 716</a></span>
<span class="normal"><a href="#__codelineno-0-717"> 717</a></span>
<span class="normal"><a href="#__codelineno-0-718"> 718</a></span>
<span class="normal"><a href="#__codelineno-0-719"> 719</a></span>
<span class="normal"><a href="#__codelineno-0-720"> 720</a></span>
<span class="normal"><a href="#__codelineno-0-721"> 721</a></span>
<span class="normal"><a href="#__codelineno-0-722"> 722</a></span>
<span class="normal"><a href="#__codelineno-0-723"> 723</a></span>
<span class="normal"><a href="#__codelineno-0-724"> 724</a></span>
<span class="normal"><a href="#__codelineno-0-725"> 725</a></span>
<span class="normal"><a href="#__codelineno-0-726"> 726</a></span>
<span class="normal"><a href="#__codelineno-0-727"> 727</a></span>
<span class="normal"><a href="#__codelineno-0-728"> 728</a></span>
<span class="normal"><a href="#__codelineno-0-729"> 729</a></span>
<span class="normal"><a href="#__codelineno-0-730"> 730</a></span>
<span class="normal"><a href="#__codelineno-0-731"> 731</a></span>
<span class="normal"><a href="#__codelineno-0-732"> 732</a></span>
<span class="normal"><a href="#__codelineno-0-733"> 733</a></span>
<span class="normal"><a href="#__codelineno-0-734"> 734</a></span>
<span class="normal"><a href="#__codelineno-0-735"> 735</a></span>
<span class="normal"><a href="#__codelineno-0-736"> 736</a></span>
<span class="normal"><a href="#__codelineno-0-737"> 737</a></span>
<span class="normal"><a href="#__codelineno-0-738"> 738</a></span>
<span class="normal"><a href="#__codelineno-0-739"> 739</a></span>
<span class="normal"><a href="#__codelineno-0-740"> 740</a></span>
<span class="normal"><a href="#__codelineno-0-741"> 741</a></span>
<span class="normal"><a href="#__codelineno-0-742"> 742</a></span>
<span class="normal"><a href="#__codelineno-0-743"> 743</a></span>
<span class="normal"><a href="#__codelineno-0-744"> 744</a></span>
<span class="normal"><a href="#__codelineno-0-745"> 745</a></span>
<span class="normal"><a href="#__codelineno-0-746"> 746</a></span>
<span class="normal"><a href="#__codelineno-0-747"> 747</a></span>
<span class="normal"><a href="#__codelineno-0-748"> 748</a></span>
<span class="normal"><a href="#__codelineno-0-749"> 749</a></span>
<span class="normal"><a href="#__codelineno-0-750"> 750</a></span>
<span class="normal"><a href="#__codelineno-0-751"> 751</a></span>
<span class="normal"><a href="#__codelineno-0-752"> 752</a></span>
<span class="normal"><a href="#__codelineno-0-753"> 753</a></span>
<span class="normal"><a href="#__codelineno-0-754"> 754</a></span>
<span class="normal"><a href="#__codelineno-0-755"> 755</a></span>
<span class="normal"><a href="#__codelineno-0-756"> 756</a></span>
<span class="normal"><a href="#__codelineno-0-757"> 757</a></span>
<span class="normal"><a href="#__codelineno-0-758"> 758</a></span>
<span class="normal"><a href="#__codelineno-0-759"> 759</a></span>
<span class="normal"><a href="#__codelineno-0-760"> 760</a></span>
<span class="normal"><a href="#__codelineno-0-761"> 761</a></span>
<span class="normal"><a href="#__codelineno-0-762"> 762</a></span>
<span class="normal"><a href="#__codelineno-0-763"> 763</a></span>
<span class="normal"><a href="#__codelineno-0-764"> 764</a></span>
<span class="normal"><a href="#__codelineno-0-765"> 765</a></span>
<span class="normal"><a href="#__codelineno-0-766"> 766</a></span>
<span class="normal"><a href="#__codelineno-0-767"> 767</a></span>
<span class="normal"><a href="#__codelineno-0-768"> 768</a></span>
<span class="normal"><a href="#__codelineno-0-769"> 769</a></span>
<span class="normal"><a href="#__codelineno-0-770"> 770</a></span>
<span class="normal"><a href="#__codelineno-0-771"> 771</a></span>
<span class="normal"><a href="#__codelineno-0-772"> 772</a></span>
<span class="normal"><a href="#__codelineno-0-773"> 773</a></span>
<span class="normal"><a href="#__codelineno-0-774"> 774</a></span>
<span class="normal"><a href="#__codelineno-0-775"> 775</a></span>
<span class="normal"><a href="#__codelineno-0-776"> 776</a></span>
<span class="normal"><a href="#__codelineno-0-777"> 777</a></span>
<span class="normal"><a href="#__codelineno-0-778"> 778</a></span>
<span class="normal"><a href="#__codelineno-0-779"> 779</a></span>
<span class="normal"><a href="#__codelineno-0-780"> 780</a></span>
<span class="normal"><a href="#__codelineno-0-781"> 781</a></span>
<span class="normal"><a href="#__codelineno-0-782"> 782</a></span>
<span class="normal"><a href="#__codelineno-0-783"> 783</a></span>
<span class="normal"><a href="#__codelineno-0-784"> 784</a></span>
<span class="normal"><a href="#__codelineno-0-785"> 785</a></span>
<span class="normal"><a href="#__codelineno-0-786"> 786</a></span>
<span class="normal"><a href="#__codelineno-0-787"> 787</a></span>
<span class="normal"><a href="#__codelineno-0-788"> 788</a></span>
<span class="normal"><a href="#__codelineno-0-789"> 789</a></span>
<span class="normal"><a href="#__codelineno-0-790"> 790</a></span>
<span class="normal"><a href="#__codelineno-0-791"> 791</a></span>
<span class="normal"><a href="#__codelineno-0-792"> 792</a></span>
<span class="normal"><a href="#__codelineno-0-793"> 793</a></span>
<span class="normal"><a href="#__codelineno-0-794"> 794</a></span>
<span class="normal"><a href="#__codelineno-0-795"> 795</a></span>
<span class="normal"><a href="#__codelineno-0-796"> 796</a></span>
<span class="normal"><a href="#__codelineno-0-797"> 797</a></span>
<span class="normal"><a href="#__codelineno-0-798"> 798</a></span>
<span class="normal"><a href="#__codelineno-0-799"> 799</a></span>
<span class="normal"><a href="#__codelineno-0-800"> 800</a></span>
<span class="normal"><a href="#__codelineno-0-801"> 801</a></span>
<span class="normal"><a href="#__codelineno-0-802"> 802</a></span>
<span class="normal"><a href="#__codelineno-0-803"> 803</a></span>
<span class="normal"><a href="#__codelineno-0-804"> 804</a></span>
<span class="normal"><a href="#__codelineno-0-805"> 805</a></span>
<span class="normal"><a href="#__codelineno-0-806"> 806</a></span>
<span class="normal"><a href="#__codelineno-0-807"> 807</a></span>
<span class="normal"><a href="#__codelineno-0-808"> 808</a></span>
<span class="normal"><a href="#__codelineno-0-809"> 809</a></span>
<span class="normal"><a href="#__codelineno-0-810"> 810</a></span>
<span class="normal"><a href="#__codelineno-0-811"> 811</a></span>
<span class="normal"><a href="#__codelineno-0-812"> 812</a></span>
<span class="normal"><a href="#__codelineno-0-813"> 813</a></span>
<span class="normal"><a href="#__codelineno-0-814"> 814</a></span>
<span class="normal"><a href="#__codelineno-0-815"> 815</a></span>
<span class="normal"><a href="#__codelineno-0-816"> 816</a></span>
<span class="normal"><a href="#__codelineno-0-817"> 817</a></span>
<span class="normal"><a href="#__codelineno-0-818"> 818</a></span>
<span class="normal"><a href="#__codelineno-0-819"> 819</a></span>
<span class="normal"><a href="#__codelineno-0-820"> 820</a></span>
<span class="normal"><a href="#__codelineno-0-821"> 821</a></span>
<span class="normal"><a href="#__codelineno-0-822"> 822</a></span>
<span class="normal"><a href="#__codelineno-0-823"> 823</a></span>
<span class="normal"><a href="#__codelineno-0-824"> 824</a></span>
<span class="normal"><a href="#__codelineno-0-825"> 825</a></span>
<span class="normal"><a href="#__codelineno-0-826"> 826</a></span>
<span class="normal"><a href="#__codelineno-0-827"> 827</a></span>
<span class="normal"><a href="#__codelineno-0-828"> 828</a></span>
<span class="normal"><a href="#__codelineno-0-829"> 829</a></span>
<span class="normal"><a href="#__codelineno-0-830"> 830</a></span>
<span class="normal"><a href="#__codelineno-0-831"> 831</a></span>
<span class="normal"><a href="#__codelineno-0-832"> 832</a></span>
<span class="normal"><a href="#__codelineno-0-833"> 833</a></span>
<span class="normal"><a href="#__codelineno-0-834"> 834</a></span>
<span class="normal"><a href="#__codelineno-0-835"> 835</a></span>
<span class="normal"><a href="#__codelineno-0-836"> 836</a></span>
<span class="normal"><a href="#__codelineno-0-837"> 837</a></span>
<span class="normal"><a href="#__codelineno-0-838"> 838</a></span>
<span class="normal"><a href="#__codelineno-0-839"> 839</a></span>
<span class="normal"><a href="#__codelineno-0-840"> 840</a></span>
<span class="normal"><a href="#__codelineno-0-841"> 841</a></span>
<span class="normal"><a href="#__codelineno-0-842"> 842</a></span>
<span class="normal"><a href="#__codelineno-0-843"> 843</a></span>
<span class="normal"><a href="#__codelineno-0-844"> 844</a></span>
<span class="normal"><a href="#__codelineno-0-845"> 845</a></span>
<span class="normal"><a href="#__codelineno-0-846"> 846</a></span>
<span class="normal"><a href="#__codelineno-0-847"> 847</a></span>
<span class="normal"><a href="#__codelineno-0-848"> 848</a></span>
<span class="normal"><a href="#__codelineno-0-849"> 849</a></span>
<span class="normal"><a href="#__codelineno-0-850"> 850</a></span>
<span class="normal"><a href="#__codelineno-0-851"> 851</a></span>
<span class="normal"><a href="#__codelineno-0-852"> 852</a></span>
<span class="normal"><a href="#__codelineno-0-853"> 853</a></span>
<span class="normal"><a href="#__codelineno-0-854"> 854</a></span>
<span class="normal"><a href="#__codelineno-0-855"> 855</a></span>
<span class="normal"><a href="#__codelineno-0-856"> 856</a></span>
<span class="normal"><a href="#__codelineno-0-857"> 857</a></span>
<span class="normal"><a href="#__codelineno-0-858"> 858</a></span>
<span class="normal"><a href="#__codelineno-0-859"> 859</a></span>
<span class="normal"><a href="#__codelineno-0-860"> 860</a></span>
<span class="normal"><a href="#__codelineno-0-861"> 861</a></span>
<span class="normal"><a href="#__codelineno-0-862"> 862</a></span>
<span class="normal"><a href="#__codelineno-0-863"> 863</a></span>
<span class="normal"><a href="#__codelineno-0-864"> 864</a></span>
<span class="normal"><a href="#__codelineno-0-865"> 865</a></span>
<span class="normal"><a href="#__codelineno-0-866"> 866</a></span>
<span class="normal"><a href="#__codelineno-0-867"> 867</a></span>
<span class="normal"><a href="#__codelineno-0-868"> 868</a></span>
<span class="normal"><a href="#__codelineno-0-869"> 869</a></span>
<span class="normal"><a href="#__codelineno-0-870"> 870</a></span>
<span class="normal"><a href="#__codelineno-0-871"> 871</a></span>
<span class="normal"><a href="#__codelineno-0-872"> 872</a></span>
<span class="normal"><a href="#__codelineno-0-873"> 873</a></span>
<span class="normal"><a href="#__codelineno-0-874"> 874</a></span>
<span class="normal"><a href="#__codelineno-0-875"> 875</a></span>
<span class="normal"><a href="#__codelineno-0-876"> 876</a></span>
<span class="normal"><a href="#__codelineno-0-877"> 877</a></span>
<span class="normal"><a href="#__codelineno-0-878"> 878</a></span>
<span class="normal"><a href="#__codelineno-0-879"> 879</a></span>
<span class="normal"><a href="#__codelineno-0-880"> 880</a></span>
<span class="normal"><a href="#__codelineno-0-881"> 881</a></span>
<span class="normal"><a href="#__codelineno-0-882"> 882</a></span>
<span class="normal"><a href="#__codelineno-0-883"> 883</a></span>
<span class="normal"><a href="#__codelineno-0-884"> 884</a></span>
<span class="normal"><a href="#__codelineno-0-885"> 885</a></span>
<span class="normal"><a href="#__codelineno-0-886"> 886</a></span>
<span class="normal"><a href="#__codelineno-0-887"> 887</a></span>
<span class="normal"><a href="#__codelineno-0-888"> 888</a></span>
<span class="normal"><a href="#__codelineno-0-889"> 889</a></span>
<span class="normal"><a href="#__codelineno-0-890"> 890</a></span>
<span class="normal"><a href="#__codelineno-0-891"> 891</a></span>
<span class="normal"><a href="#__codelineno-0-892"> 892</a></span>
<span class="normal"><a href="#__codelineno-0-893"> 893</a></span>
<span class="normal"><a href="#__codelineno-0-894"> 894</a></span>
<span class="normal"><a href="#__codelineno-0-895"> 895</a></span>
<span class="normal"><a href="#__codelineno-0-896"> 896</a></span>
<span class="normal"><a href="#__codelineno-0-897"> 897</a></span>
<span class="normal"><a href="#__codelineno-0-898"> 898</a></span>
<span class="normal"><a href="#__codelineno-0-899"> 899</a></span>
<span class="normal"><a href="#__codelineno-0-900"> 900</a></span>
<span class="normal"><a href="#__codelineno-0-901"> 901</a></span>
<span class="normal"><a href="#__codelineno-0-902"> 902</a></span>
<span class="normal"><a href="#__codelineno-0-903"> 903</a></span>
<span class="normal"><a href="#__codelineno-0-904"> 904</a></span>
<span class="normal"><a href="#__codelineno-0-905"> 905</a></span>
<span class="normal"><a href="#__codelineno-0-906"> 906</a></span>
<span class="normal"><a href="#__codelineno-0-907"> 907</a></span>
<span class="normal"><a href="#__codelineno-0-908"> 908</a></span>
<span class="normal"><a href="#__codelineno-0-909"> 909</a></span>
<span class="normal"><a href="#__codelineno-0-910"> 910</a></span>
<span class="normal"><a href="#__codelineno-0-911"> 911</a></span>
<span class="normal"><a href="#__codelineno-0-912"> 912</a></span>
<span class="normal"><a href="#__codelineno-0-913"> 913</a></span>
<span class="normal"><a href="#__codelineno-0-914"> 914</a></span>
<span class="normal"><a href="#__codelineno-0-915"> 915</a></span>
<span class="normal"><a href="#__codelineno-0-916"> 916</a></span>
<span class="normal"><a href="#__codelineno-0-917"> 917</a></span>
<span class="normal"><a href="#__codelineno-0-918"> 918</a></span>
<span class="normal"><a href="#__codelineno-0-919"> 919</a></span>
<span class="normal"><a href="#__codelineno-0-920"> 920</a></span>
<span class="normal"><a href="#__codelineno-0-921"> 921</a></span>
<span class="normal"><a href="#__codelineno-0-922"> 922</a></span>
<span class="normal"><a href="#__codelineno-0-923"> 923</a></span>
<span class="normal"><a href="#__codelineno-0-924"> 924</a></span>
<span class="normal"><a href="#__codelineno-0-925"> 925</a></span>
<span class="normal"><a href="#__codelineno-0-926"> 926</a></span>
<span class="normal"><a href="#__codelineno-0-927"> 927</a></span>
<span class="normal"><a href="#__codelineno-0-928"> 928</a></span>
<span class="normal"><a href="#__codelineno-0-929"> 929</a></span>
<span class="normal"><a href="#__codelineno-0-930"> 930</a></span>
<span class="normal"><a href="#__codelineno-0-931"> 931</a></span>
<span class="normal"><a href="#__codelineno-0-932"> 932</a></span>
<span class="normal"><a href="#__codelineno-0-933"> 933</a></span>
<span class="normal"><a href="#__codelineno-0-934"> 934</a></span>
<span class="normal"><a href="#__codelineno-0-935"> 935</a></span>
<span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="k">class</span> <span class="nc">RTUClient</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="n">api_client</span><span class="p">:</span> <span class="n">APIClient</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">file_id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">file_subscribe_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="p">):</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        High-level client over the Sending websocket backend / RTUManager (serialize websocket msgs</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">        to/from RTU models) that allows you to add callbacks by RTU event type or Delta type/action.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        - On .initialize(), will make a websocket connection to Gate</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">          - RTUManager / Sending websocket backend handles reconnection</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">          - RTUClient sets .manager.auth_hook to kick off the auth request, don&#39;t override that</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">          - awaits .on_websocket_connect() hook that you can override in application code</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        - After websocket connection is established, sends authenticate_request on system channel</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">          - Has a callback registered for &#39;authenticate_reply&#39; on system channel which will</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            await .on_auth (hook to define in application code) then send file subscribe request</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        - After authentication, sends subscribe_request to files/{file_id} channel</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">          - awaits .on_file_subscribe() hook that you can override in application code</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">        - Use .register_rtu_event_callback to register callbacks that are run against RTU messages</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">        - Use .register_delta_callback to register callbacks that are run against Deltas</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">          - May not run when message is initially received if the Delta is &quot;out of order&quot;, RTUClient</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">            handles queueing and replaying out of order deltas</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">          - Callbacks run after the Delta is &quot;squashed&quot; into {builder}</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">api_client</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">rtu_url</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOTEABLE_RTU_URL&quot;</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="ow">or</span> <span class="n">api_client</span><span class="o">.</span><span class="n">api_base_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;ws&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/v1/rtu&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">RTUManager</span><span class="p">(</span><span class="n">ws_url</span><span class="o">=</span><span class="n">rtu_url</span><span class="p">)</span>  <span class="c1"># Sending websocket backend w/ RTU serialization</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file_id</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtu_session_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Set after establishing websocket connection on .initialize()</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Set from .build_notebook, called as part of .initialize()</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># set during authenticate_reply handling, used in new_delta_request</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="c1"># When we send file subscribe request, it&#39;ll create a task to run .on_file_subscribe_timeout</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="c1"># which should blow up the RTU Client. Otherwise we can get stuck indefinitely waiting</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="c1"># for .deltas_to_apply event. If we get through initialization okay, the task will cancel</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_subcribe_timeout</span> <span class="o">=</span> <span class="n">file_subscribe_timeout</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_subscribe_timeout_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="c1"># Callbacks triggered from Sending based on websocket connection lifecycle events</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">auth_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_hook</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">connect_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_hook</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">context_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_hook</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">disconnect_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_hook</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="c1"># Callbacks that are part of the startup flow (auth and File subscribe)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span><span class="n">rtu_event</span><span class="o">=</span><span class="n">AuthenticateReply</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_auth</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">rtu_event</span><span class="o">=</span><span class="n">FileSubscribeReply</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_file_subscribe_reply</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="c1"># Incoming Delta handling. Key points here are:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="c1"># - we don&#39;t want to squash deltas until we get file subscribe reply and deltas-to-apply</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="c1"># - Deltas may be &quot;out of order&quot;, should save to be replayed later</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="c1"># - When finally applying Delta &quot;in order&quot;, then we await callbacks by delta type/action</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="c1"># See self.new_delta_request for more details on sending out Deltas</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DeltaCallback</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileDelta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># &quot;out of order deltas&quot; to be replayed</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deltas_to_apply_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>  <span class="c1"># set in ._on_file_subscribe_reply</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span><span class="n">rtu_event</span><span class="o">=</span><span class="n">NewDeltaEvent</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delta_recv</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="c1"># Kernel and cell state handling</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;not_started&quot;</span>  <span class="c1"># value used when there&#39;s no Kernel for a Notebook</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">rtu_event</span><span class="o">=</span><span class="n">KernelStatusUpdateResponse</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_kernel_status_update</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">rtu_event</span><span class="o">=</span><span class="n">BulkCellStateUpdateResponse</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_bulk_cell_state_update</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="c1"># An inconsistent state event means the Notebook was updated in a way that &quot;broke&quot; Delta</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="c1"># history, and the RTUClient needs to pull in the seed notebook and re-apply deltas from</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="c1"># a &quot;new&quot; current version id in order to catch up</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="c1">#</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="c1"># However if we get several inconsistent state events (say from getting them on file</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="c1"># resubscribe), we&#39;ll call catastrophic_failure to let the application handle tear-down</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent_state_event_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">rtu_event</span><span class="o">=</span><span class="n">InconsistentStateEvent</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_inconsistent_state_event</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="c1"># Log anytime we get an un-modeled RTU message.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="c1"># Not going through register_rtu_event_callback because isinstance would catch child classes</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">def</span> <span class="nf">predicate_fn</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">BaseRTUResponse</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_unmodeled_rtu_msg</span><span class="p">,</span> <span class="n">on_predicate</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="c1"># When someone calls .execute_cell, return an asyncio.Future that will be resolved to be</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="c1"># the updated Cell model when the cell is done executing</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">CodeCell</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">catastrophic_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        A hook for applications like PA to override so they can handle things like Pod shutdown</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">        in cases where the RTUClient cannot recover. Examples are when reloading Notebook state</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">        after inconsistent_state_event and not getting a current_version_id to subscribe by or</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        getting Deltas that cannot be squashed into the builder</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Catastrophic failure, RTU applications can override this hook&quot;</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="k">def</span> <span class="nf">cell_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of cell_id&#39;s in order from NotebookBuilder in-memory model&quot;&quot;&quot;</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="p">]</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">def</span> <span class="nf">kernel_pod_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the file_id into the Pod name used to build the kernels/ RTU channel&quot;&quot;&quot;</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;kernels/notebook-kernel-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTURequest</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        Send an RTU message to Noteable. This is not async because what&#39;s happening behind the</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">        scenes is that RTUManager.send drops the RTU pydantic model onto an &quot;outbound&quot; asyncio.Queue</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        then the &quot;outbound worker&quot; picks it up off the queue, serializes it to JSON, and sends it</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        out over the wire.</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_unmodeled_rtu_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">BaseRTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="sa">f</span><span class="s2">&quot;Received un-modeled RTU message </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">channel</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">event</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rtu_channel&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="s2">&quot;rtu_event&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">event</span><span class="p">},</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="k">def</span> <span class="nf">register_rtu_event_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtu_event</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">RTUResponse</span><span class="p">],</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        Register a callback that will be awaited whenever an RTU event is received that matches the</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">        other arguments passed in (event, channel, channel_prefix, transaction_id).</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="c1"># When Sending/RTUManager receives and deserializes a message to an RTU event, it checks</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="c1"># every registered callback. If those have a &quot;predicate_fn&quot;, it runs that fn against the</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="c1"># incoming message to decide whether to await the callback.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="c1"># The &quot;topic&quot; in the predicate_fn is always hardcoded to &quot;&quot; in the websocket backend, it&#39;s</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="c1"># used in other backends like redis just not applicable here.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">def</span> <span class="nf">predicate_fn</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rtu_event</span><span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">on_predicate</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="k">def</span> <span class="nf">register_transaction_id_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        Register a callback that will be triggered whenever an RTU message comes in with a given</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        transaction id. Useful for doing things like waiting for a reply / event or error to be</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        propogated, e.g. for new delta requests.</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">def</span> <span class="nf">predicate_fn</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">==</span> <span class="n">transaction_id</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">on_predicate</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="k">def</span> <span class="nf">register_delta_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">FileDelta</span><span class="p">],</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        Register a callback that may be triggered when we (eventually) apply an in-order Delta.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">        RTUClient has a separate mechanism for registering delta callbacks from the vanilla</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        Sending .register_callback flow because we don&#39;t necessarily want to run callbacks</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">        immediately when we observe a Delta come over the RTU websocket. We may be dealing</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">        with out-of-order deltas that are queued up and applied later on.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><span class="sd">        These callbacks are triggered by .apply_delta() and stored in a separate callback</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        list from vanilla Sending callbacks (manager.register_callback&#39;s)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">cb</span> <span class="o">=</span> <span class="n">DeltaCallback</span><span class="p">(</span><span class="n">delta_class</span><span class="o">=</span><span class="n">delta_class</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="k">return</span> <span class="n">cb</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inbound_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">outbound_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">poll_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="c1"># see Sending base.py for details, calling .initialize starts asyncio.Tasks for</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="c1"># - processing messages coming over the wire, dropping them onto inbound queue</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="c1"># - taking messages taken off the inbound queue and running callbacks</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="c1"># - taking messages from outbound queue and sending them over the wire</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="c1"># - if queue_size is 0, it means no max queue size for inbound/outbound asyncio.Queue</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_seed_notebook</span><span class="p">()</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">queue_size</span><span class="o">=</span><span class="n">queue_size</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="n">inbound_workers</span><span class="o">=</span><span class="n">inbound_workers</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="n">outbound_workers</span><span class="o">=</span><span class="n">outbound_workers</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">poll_workers</span><span class="o">=</span><span class="n">poll_workers</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">now</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">now</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="c1"># if the manager was never initialized, then the queues are None and will raise</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="c1"># AttributeError while trying to .join() them</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="k">pass</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">load_seed_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="sd">        Pull in the seed notebook that will be the base document model of the NotebookBuilder, which</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">        can then squash Deltas that update the Notebook, including deltas_to_apply on file subscribe</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">        which represents changes that may have happened since the last &quot;save&quot; to s3.</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">         - Get current file version and presigned url from /v1/files endpoint</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">         - Download and parse seed notebook into Notebook / NotebookBuilder</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="n">file</span><span class="p">:</span> <span class="n">File</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="c1"># Current file version id is used in file subscribe request</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">current_version_id</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gate shows no current version id for File </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">, aborting.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">catastrophic_failure</span><span class="p">()</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_version_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">current_version_id</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading seed Notebook&quot;</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="c1"># Download seed Notebook and parse into Notebook / NotebookBuilder</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="c1"># TODO: remove this hack if/when we get containers in Skaffold to be able to translate</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="c1"># localhost urls to the minio pod/container -- relevant to Noteable devs only</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="k">if</span> <span class="s2">&quot;LOCAL_K8S&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LOCAL_K8S&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="n">file</span><span class="o">.</span><span class="n">presigned_download_url</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">presigned_download_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;minio&quot;</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">plain_http_client</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">plain_http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">presigned_download_url</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="n">seed_notebook</span> <span class="o">=</span> <span class="n">Notebook</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">NotebookBuilder</span><span class="p">(</span><span class="n">seed_notebook</span><span class="o">=</span><span class="n">seed_notebook</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="c1"># See Sending backends.websocket for details but a quick refresher on hook timing:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="c1"># - context_hook is called within the while True loop for inbound worker, outbound worker,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>    <span class="c1">#   and poll_worker, it&#39;s for binding contextvars to every function call</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="c1"># - connect_hook is called on websocket connect/reconnect, after resolving .unauth_ws future</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="c1"># - auth_hook is called after connect_hook</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>    <span class="c1"># - init_hook is called after auth_hook</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="c1"># - disconnect_hook is called when websocket disconnects, before reconnect attempt</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="c1"># Re: *args / **kwargs in all hooks except context_hook below: Sending passes &#39;self&#39; (mgr)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="c1"># as an arg to those, but we don&#39;t need to use it since we have self.manager to ref.</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">context_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="c1"># In application code, might want to put structlog.bind_contextvars here</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="k">pass</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>        <span class="n">ws</span><span class="p">:</span> <span class="n">WebSocketClientProtocol</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">unauth_ws</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtu_session_id</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">response_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rtu_session_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">disconnect_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rtu_session_id</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">auth_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">        Called after the websocket connection is established. This also implicitly makes it so</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">        .send() / ._publish will effectively suspend sending messages over the websocket</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="sd">        until we&#39;ve observed an `authenticate_reply` event</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="n">jwt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">jwt</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="n">auth_request</span> <span class="o">=</span> <span class="n">AuthenticateRequest</span><span class="p">(</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">jwt</span><span class="p">,</span> <span class="s2">&quot;rtu_client_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">creator_client_type</span><span class="p">}</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="c1"># auth_hook is the special situation that shouldn&#39;t use manager.send(),</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="c1"># since that will ultimately delay sending things over the wire until</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="c1"># we observe the auth reply. Instead use the unauth_ws directly and manually serialize</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>        <span class="n">ws</span><span class="p">:</span> <span class="n">WebSocketClientProtocol</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">unauth_ws</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending auth request with jwt </span><span class="si">{</span><span class="n">jwt</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="n">jwt</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">auth_request</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">())</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">AuthenticateReply</span><span class="p">):</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="c1"># hook for Application code to override, consider catastrophic failure on auth failure</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication failed: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">AuthenticateReply</span><span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">        Callback for event=&#39;authenticate_reply&#39; on &#39;system&#39; channel.</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">        Application probably doesn&#39;t need to override this, override .on_auth instead which gets</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">        awaited before this method sends out the file subscribe request.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Authentication successful&quot;</span><span class="p">)</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">authed_ws</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                <span class="c1"># We&#39;ve seen that sometimes on websocket reconnect, trying to .authed_ws.set_result</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="c1"># throws an asyncio.InvalidStateError: Result is already set.</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="c1"># Still a mystery how this happens, Sending websocket backend resets the authed_ws</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="c1"># Future on websocket reconnect in a try / finally. If you figure it out, please</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                <span class="c1"># create an issue or PR!</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Authed websocket future already set, resetting to a new Future.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">authed_ws</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">authed_ws</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">unauth_ws</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_file_subscribe</span><span class="p">()</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error sending file subscribe request&quot;</span><span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_auth</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_file_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">        Once `authenticate_reply` is observed, we should send the File subscription request.</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>        <span class="c1"># If our NotebookBuilder hasn&#39;t applied any deltas yet, then we should subscribe</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="c1"># by the version_id. That is, we think we&#39;ve pulled down a clean seed Notebook by</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="c1"># s3 version id, and need to get deltas by the matching noteable version id.</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>        <span class="c1">#</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="c1"># However if we&#39;ve started applying deltas, such as after a Gate crash and RTU</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="c1"># reconnect, then subscribe by the last applied delta id.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="c1">#</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="c1"># Note this also means file subscribe won&#39;t happen until after we&#39;ve pulled down</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="c1"># the seed notebook from s3 for the first time, which is probably fine.</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>        <span class="c1">#</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="c1"># Second note, subscribing by delta id all-0&#39;s throws an error in Gate.</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="o">!=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># type: ignore # noqa: E501</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                <span class="s2">&quot;Sending File subscribe request by last applied delta id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;from_delta_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">)},</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>            <span class="p">)</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>            <span class="n">req_data</span> <span class="o">=</span> <span class="n">FileSubscribeRequestData</span><span class="p">(</span><span class="n">from_delta_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="n">req</span> <span class="o">=</span> <span class="n">FileSubscribeRequest</span><span class="p">(</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>                <span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>                <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>            <span class="p">)</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>                <span class="s2">&quot;Sending File subscribe request by version id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;from_version_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_version_id</span><span class="p">)},</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>            <span class="p">)</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="n">req_data</span> <span class="o">=</span> <span class="n">FileSubscribeRequestData</span><span class="p">(</span><span class="n">from_version_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_version_id</span><span class="p">)</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="n">req</span> <span class="o">=</span> <span class="n">FileSubscribeRequest</span><span class="p">(</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>                <span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>                <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>            <span class="p">)</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_subscribe_timeout_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_file_subscribe_timeout</span><span class="p">())</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_file_subscribe_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">        Hook for Application code to override if we don&#39;t get the expected file subscribe reply</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><span class="sd">        after some amount of seconds. Without a timeout, RTU Clients can easily get stuck forever</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">        awaiting the .deltas_to_apply event that is resolved in file subscribe reply.</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_subcribe_timeout</span><span class="p">)</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;File subscribe timeout reached&quot;</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;File subscribe reply timeout&quot;</span><span class="p">)</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_file_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FileSubscribeReply</span><span class="p">):</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="c1"># hook for Application code to override if it wants to do something special with</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="c1"># file subscribe reply event on files/{self.file-id} channel</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="k">pass</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_file_subscribe_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FileSubscribeReply</span><span class="p">):</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">        Callback for event &#39;subscribe_reply&#39; on &#39;files/{self.file-id}&#39; channel</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">        The file subscribe reply contains a bunch of information including which users are</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">        subscribed to the Notebook (has it open in their browser), which Application code may care</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">        about and want to handle in .on_file_subscribe.</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">        Here the main concern is to handle &quot;deltas to apply&quot;, which are any deltas that have been</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">        created in between when our seed notebook version id was &quot;squashed&quot; and when we subscribed</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a><span class="sd">        to the file by version id / last delta id.</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>        <span class="c1"># Kernel and cell states if there is a live Kernel</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">kernel_session</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">kernel_session</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">execution_state</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cell_states</span><span class="p">:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cell_states</span><span class="p">}</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>        <span class="c1"># Go through &quot;Delta catchup&quot; and signal to ourselves that we can begin handling any new</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="c1"># deltas coming in over the websocket. It&#39;s important not to start squashing incoming</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>        <span class="c1"># deltas until after we get the file subscribe and replay &quot;deltas to apply&quot; if there are any</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>        <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">deltas_to_apply</span><span class="p">:</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_or_apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deltas_to_apply_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="c1"># Prepare to replay any Deltas we received while waiting for file subscribe response.</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="c1"># If we had deltas to apply, then Notebook Builder has a last applied delta id.</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="c1"># If we did not, then we rely on Gate to have told us where the &quot;root&quot; of our deltas</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="c1"># starts, so we don&#39;t apply deltas out of order at the start.</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">:</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latest_delta_id</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_unapplied_deltas</span><span class="p">()</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>        <span class="c1"># Cancel the timeout task, should always exist but guarding against unexpected runtime err</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_subscribe_timeout_task</span><span class="p">:</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_subscribe_timeout_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>        <span class="c1"># Now all &quot;Delta catchup&quot; and &quot;inflight Deltas&quot; have been processed.</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>        <span class="c1"># Application code may want to do extra things like subscribe to kernels channel or users</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>        <span class="c1"># channel for each msg.data[&#39;user_subscriptions&#39;].</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_file_subscribe</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">file_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">        Send file unsubscribe request to Gate. This is called when the RTUClient is shutting down.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>        <span class="n">req</span> <span class="o">=</span> <span class="n">FileUnsubscribeRequest</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_inconsistent_state_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InconsistentStateEvent</span><span class="p">):</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">        To &quot;reset&quot; our internal document model, we need to unsubscribe from the files channel at</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">        the least, to stop getting new deltas in. Then we need to figure out what the new current</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">        version id is, and pull down seed notebook, and then resubscribe to file channel.</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent_state_event_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Calling catastrophic failure after 3 inconsistent state events&quot;</span><span class="p">)</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">catastrophic_failure</span><span class="p">()</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received inconsistent state event, resetting NotebookBuilder&quot;</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>        <span class="c1"># There&#39;s the chance for some gnarly but rare edge cases here that would probably take a</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>        <span class="c1"># serious amount of thinking and logic to handle. Basically, what happens if new Deltas</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>        <span class="c1"># come in while we&#39;re trying to &quot;reset&quot; the document model after an inconsistent state?</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>        <span class="c1"># - Can the unsubscribe be handled in Gate after the second subscribe? Unlikely since it&#39;s</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>        <span class="c1">#   the same Gate handling both (websocket, sticky session).</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="c1"># - Can Deltas end up coming in out of order, something come over the wire while we&#39;re</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>        <span class="c1">#   in the middle of resetting? Potentially, but that would just end up leading to failure</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>        <span class="c1">#   to apply delta and catastrophic failure, which is effectively what we were doing on</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>        <span class="c1">#   inconsistent_state_event before adding this method here.</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_unsubscribe</span><span class="p">()</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_seed_notebook</span><span class="p">()</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_file_subscribe</span><span class="p">()</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent_state_event_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_on_delta_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">NewDeltaEvent</span><span class="p">):</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">        Extract delta from GenericRTUReply and delegate to .queue_or_apply_delta</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>        <span class="c1"># We may receive RTU / Delta events while we&#39;re still waiting to get a file_subscribe</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="c1"># reply, which contains &quot;delta catchup&quot; which need to be applied before new deltas.</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="c1"># We shot ourselves in the foot once by waiting for the deltas_to_apply_event in this method</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="c1"># but that blocks handling any other received websocket/RTU messages. Instead, the right</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="c1"># thing to do is probably add these to the unapplied_deltas list if we haven&#39;t done delta</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="c1"># catchup yet.</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltas_to_apply_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_or_apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">queue_or_apply_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">        Checks whether we&#39;re able to apply the Delta by comparing its</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="sd">        parent_delta_id with the last_applied_delta_id in the NBBuilder.</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">        If it is not a match, we may have received out of order deltas and we</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a><span class="sd">        queue it to be replayed later</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>            <span class="c1"># We need this for situations where we&#39;ve downloaded the seed notebook and gotten deltas</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>            <span class="c1"># to apply from file subscribe reply, but do not have information about what the first</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>            <span class="c1"># delta in that deltas-to-apply list is.</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="k">elif</span> <span class="n">delta</span><span class="o">.</span><span class="n">parent_delta_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">:</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>            <span class="c1"># For logging related to applying delta, override .pre_apply_delta</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_unapplied_deltas</span><span class="p">()</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>            <span class="c1"># For logging related to queueing &quot;out of order&quot; Deltas, override .post_queue_delta</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_queue_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">post_queue_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="sd">        Hook for Application code to override if it wants to do something special when queueing</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">        &quot;out of order&quot; Deltas.</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>        <span class="k">pass</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">pre_apply_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">        Hook for Application code to override if it wants to do something special before running</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">        &quot;squashing&quot; Delta into NotebookBuilder and running applicable callbacks.</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>        <span class="k">pass</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">failed_to_squash_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">        Hook for Application code to override when a Delta fails to &quot;squash&quot; into the in-memory</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">        Notebook representation.</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>        <span class="k">pass</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">apply_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a><span class="sd">        Squash a Delta into the NotebookBuilder and run applicable callbacks</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="sd">         - If squashing a Delta into the in-memory Notebook representation fails for some reason,</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">           then PA basically needs to crash because all follow on Delta application is very suspect</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">           (e.g. future deltas think a cell exists when it doesn&#39;t, or content exists, etc)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="sd">         - If callbacks are triggered, it is okay for them to fail and we just log it because those</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="sd">           are generally just side-effects, not core to applying future deltas</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">        Note on alternative approach to handling delta squashing failures: @Seal suggested</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">        redownloading Notebook and starting from latest delta rather than killing Kernel Pod but</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">        we don&#39;t have great comm mechanisms for PA to tell Gate to squash the problematic Delta or</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">        to figure out the most recent version in Cockroach / S3. For now, killing Kernel Pod on</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><span class="sd">        NotebookBuilder apply and logging errors on side-effect callbacks is the best we can do.</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>            <span class="c1"># &quot;squash&quot; delta into in-memory notebook representation</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_to_squash_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>        <span class="c1"># Run applicable callbacks concurrently, await all of them completing.</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="p">:</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">dc</span><span class="o">.</span><span class="n">delta_class</span><span class="p">):</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>                <span class="c1"># Add coroutine to the callbacks list</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>                <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>        <span class="c1"># Log errors on callbacks but don&#39;t stop RTU processing loop</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>        <span class="k">for</span> <span class="n">callback</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>                    <span class="s2">&quot;Error trying to run callback while applying delta&quot;</span><span class="p">,</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>                    <span class="n">exc_info</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>                        <span class="s2">&quot;callback&quot;</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>                        <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">delta</span><span class="p">,</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>                        <span class="s2">&quot;ename&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>                        <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>                    <span class="p">},</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>                <span class="p">)</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">replay_unapplied_deltas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a><span class="sd">        Attempt to apply any previous unapplied Deltas that were received out of order.</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a><span class="sd">        Calls itself recursively in case replaying unapplied deltas resulted in multiple</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a><span class="sd">        Deltas now being able to be applied. E.g. we received in order:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a><span class="sd">         - {&#39;id&#39;: 2, &#39;parent_id&#39;: 1} # applied because NBBuilder had no last_applied_delta_id</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a><span class="sd">         - {&#39;id&#39;: 5, &#39;parent_id&#39;: 4} # queued because parent_id doesn&#39;t match builder</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a><span class="sd">         - {&#39;id&#39;: 4, &#39;parent_id&#39;: 3} # queued because parent_id doesn&#39;t match builder</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a><span class="sd">         - {&#39;id&#39;: 3, &#39;parent_id&#39;: 2} # applied, then needs to replay queued deltas</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="sd">        Replaying would make the third received delta be applied, which would let</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="sd">        replaying again also apply the second delta.</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="p">:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>            <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">parent_delta_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">:</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>                    <span class="s2">&quot;Applying previously queued out of order delta&quot;</span><span class="p">,</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;delta_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>                <span class="p">)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_unapplied_deltas</span><span class="p">()</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>    <span class="c1"># Kernel and Cell states</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_kernel_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">KernelStatusUpdateResponse</span><span class="p">):</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Called when we receive a kernel_status_update_event on kernels/ channel&quot;&quot;&quot;</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">execution_state</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;updating Kernel state to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_bulk_cell_state_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">BulkCellStateUpdateResponse</span><span class="p">):</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Called when we receive a bulk_cell_state_update_event on kernels/ channel&quot;&quot;&quot;</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cell_states</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cell_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">:</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="c1"># When we see that a cell we&#39;re monitoring has finished, resolve the Future to</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                <span class="c1"># be the cell</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;finished_with_error&quot;</span><span class="p">,</span> <span class="s2">&quot;finished_with_no_error&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>                        <span class="s2">&quot;Cell execution for monitored cell finished&quot;</span><span class="p">,</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>                            <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>                        <span class="p">},</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>                    <span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>                    <span class="n">fut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">]</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                            <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                            <span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                        <span class="k">except</span> <span class="n">CellNotFound</span><span class="p">:</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                            <span class="c1"># This could happen if a cell was deleted in the middle of execution</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>                                <span class="s2">&quot;Cell execution finished for cell that doesn&#39;t exist in Notebook&quot;</span><span class="p">,</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>                                    <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>                                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                                <span class="p">},</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                            <span class="p">)</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                            <span class="n">fut</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">CellNotFound</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">))</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated cell states&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cell_states&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span><span class="p">})</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_kernel_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for the kernel to be idle&quot;&quot;&quot;</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for Kernel to be idle&quot;</span><span class="p">)</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">!=</span> <span class="s2">&quot;idle&quot;</span><span class="p">:</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Kernel is idle&quot;</span><span class="p">)</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">new_delta_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">FileDelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FileDelta</span><span class="p">:</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a><span class="sd">        Send a new delta request to the server and wait for it to have been accepted and propogated</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a><span class="sd">        to other clients, as well as squashed into our own in-memory Notebook.</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a><span class="sd">        Raises errors if the Delta was rejected for any reason.</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>        <span class="n">req</span> <span class="o">=</span> <span class="n">DeltaRequestCallbackManager</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>        <span class="k">return</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">result</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_cell</span><span class="p">(</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>        <span class="n">cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NotebookCell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>        <span class="n">before_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>        <span class="n">after_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="sd">        Adds a Cell to the Notebook.</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="sd">         - if a cell is passed in, will use that or otherwise make a CodeCell from source value</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="sd">         - If before_id and after_id are unspecified, then it will add the new cell at the bottom of</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a><span class="sd">            the notebook.</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell</span><span class="p">:</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>            <span class="n">cell</span> <span class="o">=</span> <span class="n">CodeCell</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>        <span class="c1"># Default behavior: add cell to end of Notebook. Guard against a Notebook with no cells</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">before_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">after_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">:</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>            <span class="n">after_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>        <span class="n">props</span> <span class="o">=</span> <span class="n">NBCellsAddProperties</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span> <span class="n">before_id</span><span class="o">=</span><span class="n">before_id</span><span class="p">,</span> <span class="n">after_id</span><span class="o">=</span><span class="n">after_id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">NBCellsAdd</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>        <span class="c1"># grab newly-squashed cell</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>        <span class="k">return</span> <span class="n">cell</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NBCellsDelete</span><span class="p">:</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">NBCellsDelete</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cell_id</span><span class="p">})</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">change_cell_type</span><span class="p">(</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>        <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>        <span class="n">cell_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;markdown&quot;</span><span class="p">,</span> <span class="s2">&quot;sql&quot;</span><span class="p">],</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>        <span class="n">code_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>        <span class="n">db_connection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;@noteable&quot;</span><span class="p">,</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>        <span class="n">assign_results_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="sd">        Switch a cell between code, markdown, or SQL cell.</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="sd">         - code_language only relevant when switching to code cell</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a><span class="sd">         - db_connection and assign_results_to only relevant when switching to SQL cell</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>  <span class="c1"># Raise CellNotFound if it doesn&#39;t exist</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>        <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataReplace</span><span class="p">(</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>                <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>                <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="n">code_language</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">},</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>            <span class="p">)</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataReplace</span><span class="p">(</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>                <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>                <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;markdown&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;markdown&quot;</span><span class="p">},</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>            <span class="p">)</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>        <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;sql&quot;</span><span class="p">:</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataReplace</span><span class="p">(</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>                <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>                <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>                <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;sql&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">},</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>            <span class="p">)</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">assign_results_to</span><span class="p">:</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>                <span class="n">name_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a>                <span class="n">assign_results_to</span> <span class="o">=</span> <span class="s2">&quot;df_&quot;</span> <span class="o">+</span> <span class="n">name_suffix</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataUpdate</span><span class="p">(</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a>                <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a>                <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a>                <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a>                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;noteable&quot;</span><span class="p">],</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a>                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>                        <span class="s2">&quot;cell_type&quot;</span><span class="p">:</span> <span class="s2">&quot;sql&quot;</span><span class="p">,</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>                        <span class="s2">&quot;db_connection&quot;</span><span class="p">:</span> <span class="n">db_connection</span><span class="p">,</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>                        <span class="s2">&quot;assign_results_to&quot;</span><span class="p">:</span> <span class="n">assign_results_to</span><span class="p">,</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>                    <span class="p">},</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>                <span class="p">},</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>            <span class="p">)</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown cell type </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>        <span class="c1"># Grab updated cell post-squashing</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>        <span class="k">return</span> <span class="n">cell</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_cell_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">patch</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a><span class="sd">        Update cell content with a diff-match-patch patch string</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellContentsUpdate</span><span class="p">(</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>            <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span><span class="p">}</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>        <span class="p">)</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>        <span class="c1"># Grab updated cell post-squashing</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>        <span class="k">return</span> <span class="n">cell</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">replace_cell_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a><span class="sd">        Replace cell content with a string</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellContentsReplace</span><span class="p">(</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>            <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">}</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>        <span class="p">)</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>        <span class="c1"># Grab updated cell post-squashing</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>        <span class="k">return</span> <span class="n">cell</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">queue_execution</span><span class="p">(</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>        <span class="n">cell_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>        <span class="n">before_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>        <span class="n">after_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>        <span class="n">run_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">CodeCell</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a><span class="sd">        Execute an individual cell or multiple cells in the Notebook. The return value is a dict of</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a><span class="sd">        {future: cell_id}, even in the case of executing a single cell.</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a><span class="sd">         - Only code Cells can be executed. When running multiple cells with before / after / all</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a><span class="sd">           non-code cells will be excluded automatically</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a><span class="sd">         - Code cells with no source are not executed on Noteable backend, so they&#39;ll be skipped</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="sd">         - Outputs should be available from the cell.output_collection_id property</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="sd">        Use:</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a><span class="sd">        queued_execute = await rtu_client.queue_execution(run_all=True)</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="sd">        done, pending = await asyncio.wait(*queued_execute, timeout=5)</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="sd">        still_running_cell_ids = [queued_execute[f] for f in pending]</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">before_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">after_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_all</span><span class="p">:</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One of cell_id, before_id, after_id, or run_all must be set.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">==</span> <span class="s2">&quot;not_started&quot;</span><span class="p">:</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>                <span class="s2">&quot;Cannot submit cell execution requests for Notebook that has not started a Kernel. Use api_client.launch_kernel to start one.&quot;</span>  <span class="c1"># noqa: E501</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>            <span class="p">)</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>        <span class="k">if</span> <span class="n">cell_id</span><span class="p">:</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>            <span class="n">cell_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecute</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>        <span class="k">elif</span> <span class="n">before_id</span><span class="p">:</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>            <span class="n">idx</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">before_id</span><span class="p">)</span>  <span class="c1"># can raise CellNotFound</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>            <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># inclusive of the &quot;before_id&quot; cell</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecuteBefore</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">before_id</span><span class="p">)</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>        <span class="k">elif</span> <span class="n">after_id</span><span class="p">:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>            <span class="n">idx</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">after_id</span><span class="p">)</span>  <span class="c1"># can raise CellNotFound</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>            <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>  <span class="c1"># inclusive of the &quot;after_id&quot; cell</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecuteAfter</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">after_id</span><span class="p">)</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>            <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[:]</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>            <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecuteAll</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>        <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cell_ids</span><span class="p">:</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>            <span class="c1"># Only create futures for Code cells that have something in source. Otherwise the cell</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>            <span class="c1"># will never get executed by PA/Kernel, so we&#39;d never see cell status and resolve future</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>            <span class="n">idx</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>                <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_id</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>        <span class="k">return</span> <span class="n">futures</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h3 id="clients.rtu.RTUClient.cell_ids" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cell_ids</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#clients.rtu.RTUClient.cell_ids" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return list of cell_id's in order from NotebookBuilder in-memory model</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h3 id="clients.rtu.RTUClient.kernel_pod_name" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">kernel_pod_name</span><span class="p">:</span> <span class="nb">str</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#clients.rtu.RTUClient.kernel_pod_name" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Transform the file_id into the Pod name used to build the kernels/ RTU channel</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">api_client</span><span class="p">,</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">file_subscribe_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

<a href="#clients.rtu.RTUClient.__init__" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>High-level client over the Sending websocket backend / RTUManager (serialize websocket msgs
to/from RTU models) that allows you to add callbacks by RTU event type or Delta type/action.</p>
<ul>
<li>On .initialize(), will make a websocket connection to Gate</li>
<li>RTUManager / Sending websocket backend handles reconnection</li>
<li>RTUClient sets .manager.auth_hook to kick off the auth request, don't override that</li>
<li>
<p>awaits .on_websocket_connect() hook that you can override in application code</p>
</li>
<li>
<p>After websocket connection is established, sends authenticate_request on system channel</p>
</li>
<li>
<p>Has a callback registered for 'authenticate_reply' on system channel which will
    await .on_auth (hook to define in application code) then send file subscribe request</p>
</li>
<li>
<p>After authentication, sends subscribe_request to files/{file_id} channel</p>
</li>
<li>
<p>awaits .on_file_subscribe() hook that you can override in application code</p>
</li>
<li>
<p>Use .register_rtu_event_callback to register callbacks that are run against RTU messages</p>
</li>
<li>
<p>Use .register_delta_callback to register callbacks that are run against Deltas</p>
</li>
<li>May not run when message is initially received if the Delta is "out of order", RTUClient
    handles queueing and replaying out of order deltas</li>
<li>Callbacks run after the Delta is "squashed" into {builder}</li>
</ul>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="n">api_client</span><span class="p">:</span> <span class="n">APIClient</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="n">file_id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">file_subscribe_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="p">):</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">    High-level client over the Sending websocket backend / RTUManager (serialize websocket msgs</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    to/from RTU models) that allows you to add callbacks by RTU event type or Delta type/action.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    - On .initialize(), will make a websocket connection to Gate</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">      - RTUManager / Sending websocket backend handles reconnection</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">      - RTUClient sets .manager.auth_hook to kick off the auth request, don&#39;t override that</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">      - awaits .on_websocket_connect() hook that you can override in application code</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">    - After websocket connection is established, sends authenticate_request on system channel</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">      - Has a callback registered for &#39;authenticate_reply&#39; on system channel which will</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        await .on_auth (hook to define in application code) then send file subscribe request</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    - After authentication, sends subscribe_request to files/{file_id} channel</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">      - awaits .on_file_subscribe() hook that you can override in application code</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    - Use .register_rtu_event_callback to register callbacks that are run against RTU messages</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    - Use .register_delta_callback to register callbacks that are run against Deltas</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">      - May not run when message is initially received if the Delta is &quot;out of order&quot;, RTUClient</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        handles queueing and replaying out of order deltas</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">      - Callbacks run after the Delta is &quot;squashed&quot; into {builder}</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">api_client</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="n">rtu_url</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NOTEABLE_RTU_URL&quot;</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="ow">or</span> <span class="n">api_client</span><span class="o">.</span><span class="n">api_base_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;ws&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/v1/rtu&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">RTUManager</span><span class="p">(</span><span class="n">ws_url</span><span class="o">=</span><span class="n">rtu_url</span><span class="p">)</span>  <span class="c1"># Sending websocket backend w/ RTU serialization</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">file_id</span> <span class="o">=</span> <span class="n">file_id</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rtu_session_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Set after establishing websocket connection on .initialize()</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Set from .build_notebook, called as part of .initialize()</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># set during authenticate_reply handling, used in new_delta_request</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="c1"># When we send file subscribe request, it&#39;ll create a task to run .on_file_subscribe_timeout</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="c1"># which should blow up the RTU Client. Otherwise we can get stuck indefinitely waiting</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="c1"># for .deltas_to_apply event. If we get through initialization okay, the task will cancel</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">file_subcribe_timeout</span> <span class="o">=</span> <span class="n">file_subscribe_timeout</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">file_subscribe_timeout_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="c1"># Callbacks triggered from Sending based on websocket connection lifecycle events</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">auth_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_hook</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">connect_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_hook</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">context_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_hook</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">disconnect_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_hook</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="c1"># Callbacks that are part of the startup flow (auth and File subscribe)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span><span class="n">rtu_event</span><span class="o">=</span><span class="n">AuthenticateReply</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_auth</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">rtu_event</span><span class="o">=</span><span class="n">FileSubscribeReply</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_file_subscribe_reply</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># Incoming Delta handling. Key points here are:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="c1"># - we don&#39;t want to squash deltas until we get file subscribe reply and deltas-to-apply</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="c1"># - Deltas may be &quot;out of order&quot;, should save to be replayed later</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="c1"># - When finally applying Delta &quot;in order&quot;, then we await callbacks by delta type/action</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="c1"># See self.new_delta_request for more details on sending out Deltas</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DeltaCallback</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileDelta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># &quot;out of order deltas&quot; to be replayed</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">deltas_to_apply_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>  <span class="c1"># set in ._on_file_subscribe_reply</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span><span class="n">rtu_event</span><span class="o">=</span><span class="n">NewDeltaEvent</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delta_recv</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="c1"># Kernel and cell state handling</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;not_started&quot;</span>  <span class="c1"># value used when there&#39;s no Kernel for a Notebook</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">rtu_event</span><span class="o">=</span><span class="n">KernelStatusUpdateResponse</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_kernel_status_update</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">rtu_event</span><span class="o">=</span><span class="n">BulkCellStateUpdateResponse</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_bulk_cell_state_update</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="c1"># An inconsistent state event means the Notebook was updated in a way that &quot;broke&quot; Delta</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="c1"># history, and the RTUClient needs to pull in the seed notebook and re-apply deltas from</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="c1"># a &quot;new&quot; current version id in order to catch up</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="c1">#</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="c1"># However if we get several inconsistent state events (say from getting them on file</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="c1"># resubscribe), we&#39;ll call catastrophic_failure to let the application handle tear-down</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent_state_event_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_rtu_event_callback</span><span class="p">(</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">rtu_event</span><span class="o">=</span><span class="n">InconsistentStateEvent</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_inconsistent_state_event</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="c1"># Log anytime we get an un-modeled RTU message.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="c1"># Not going through register_rtu_event_callback because isinstance would catch child classes</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">def</span> <span class="nf">predicate_fn</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="n">BaseRTUResponse</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_unmodeled_rtu_msg</span><span class="p">,</span> <span class="n">on_predicate</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="c1"># When someone calls .execute_cell, return an asyncio.Future that will be resolved to be</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="c1"># the updated Cell model when the cell is done executing</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">CodeCell</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.add_cell" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_cell</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">before_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">after_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.add_cell" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Adds a Cell to the Notebook.
 - if a cell is passed in, will use that or otherwise make a CodeCell from source value
 - If before_id and after_id are unspecified, then it will add the new cell at the bottom of
    the notebook.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-846" name="__codelineno-0-846"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">add_cell</span><span class="p">(</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>    <span class="n">cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NotebookCell</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>    <span class="n">before_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>    <span class="n">after_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="sd">    Adds a Cell to the Notebook.</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="sd">     - if a cell is passed in, will use that or otherwise make a CodeCell from source value</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="sd">     - If before_id and after_id are unspecified, then it will add the new cell at the bottom of</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a><span class="sd">        the notebook.</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cell</span><span class="p">:</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a>        <span class="n">cell</span> <span class="o">=</span> <span class="n">CodeCell</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>    <span class="c1"># Default behavior: add cell to end of Notebook. Guard against a Notebook with no cells</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">before_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">after_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">:</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>        <span class="n">after_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>    <span class="n">props</span> <span class="o">=</span> <span class="n">NBCellsAddProperties</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span> <span class="n">before_id</span><span class="o">=</span><span class="n">before_id</span><span class="p">,</span> <span class="n">after_id</span><span class="o">=</span><span class="n">after_id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">cell</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="n">NBCellsAdd</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>    <span class="c1"># grab newly-squashed cell</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>    <span class="k">return</span> <span class="n">cell</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.apply_delta" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.apply_delta" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Squash a Delta into the NotebookBuilder and run applicable callbacks</p>
<ul>
<li>If squashing a Delta into the in-memory Notebook representation fails for some reason,
   then PA basically needs to crash because all follow on Delta application is very suspect
   (e.g. future deltas think a cell exists when it doesn't, or content exists, etc)</li>
<li>If callbacks are triggered, it is okay for them to fail and we just log it because those
   are generally just side-effects, not core to applying future deltas</li>
</ul>
<p>Note on alternative approach to handling delta squashing failures: @Seal suggested
redownloading Notebook and starting from latest delta rather than killing Kernel Pod but
we don't have great comm mechanisms for PA to tell Gate to squash the problematic Delta or
to figure out the most recent version in Cockroach / S3. For now, killing Kernel Pod on
NotebookBuilder apply and logging errors on side-effect callbacks is the best we can do.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-723" name="__codelineno-0-723"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">apply_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a><span class="sd">    Squash a Delta into the NotebookBuilder and run applicable callbacks</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="sd">     - If squashing a Delta into the in-memory Notebook representation fails for some reason,</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">       then PA basically needs to crash because all follow on Delta application is very suspect</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">       (e.g. future deltas think a cell exists when it doesn&#39;t, or content exists, etc)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="sd">     - If callbacks are triggered, it is okay for them to fail and we just log it because those</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="sd">       are generally just side-effects, not core to applying future deltas</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">    Note on alternative approach to handling delta squashing failures: @Seal suggested</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">    redownloading Notebook and starting from latest delta rather than killing Kernel Pod but</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">    we don&#39;t have great comm mechanisms for PA to tell Gate to squash the problematic Delta or</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">    to figure out the most recent version in Cockroach / S3. For now, killing Kernel Pod on</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><span class="sd">    NotebookBuilder apply and logging errors on side-effect callbacks is the best we can do.</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>        <span class="c1"># &quot;squash&quot; delta into in-memory notebook representation</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_to_squash_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">exc</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="c1"># Run applicable callbacks concurrently, await all of them completing.</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>    <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="p">:</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">dc</span><span class="o">.</span><span class="n">delta_class</span><span class="p">):</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>            <span class="c1"># Add coroutine to the callbacks list</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>            <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>    <span class="c1"># Log errors on callbacks but don&#39;t stop RTU processing loop</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>    <span class="k">for</span> <span class="n">callback</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">callbacks</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>                <span class="s2">&quot;Error trying to run callback while applying delta&quot;</span><span class="p">,</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>                <span class="n">exc_info</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>                    <span class="s2">&quot;callback&quot;</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>                    <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">delta</span><span class="p">,</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>                    <span class="s2">&quot;ename&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>                    <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>                <span class="p">},</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.auth_hook" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">auth_hook</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.auth_hook" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Called after the websocket connection is established. This also implicitly makes it so
.send() / ._publish will effectively suspend sending messages over the websocket
until we've observed an <code>authenticate_reply</code> event</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-485" name="__codelineno-0-485"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">auth_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="sd">    Called after the websocket connection is established. This also implicitly makes it so</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a><span class="sd">    .send() / ._publish will effectively suspend sending messages over the websocket</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="sd">    until we&#39;ve observed an `authenticate_reply` event</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="n">jwt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">jwt</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="n">auth_request</span> <span class="o">=</span> <span class="n">AuthenticateRequest</span><span class="p">(</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">jwt</span><span class="p">,</span> <span class="s2">&quot;rtu_client_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">creator_client_type</span><span class="p">}</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>    <span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="c1"># auth_hook is the special situation that shouldn&#39;t use manager.send(),</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>    <span class="c1"># since that will ultimately delay sending things over the wire until</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>    <span class="c1"># we observe the auth reply. Instead use the unauth_ws directly and manually serialize</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="n">ws</span><span class="p">:</span> <span class="n">WebSocketClientProtocol</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">unauth_ws</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending auth request with jwt </span><span class="si">{</span><span class="n">jwt</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="n">jwt</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">auth_request</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.catastrophic_failure" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">catastrophic_failure</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.catastrophic_failure" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>A hook for applications like PA to override so they can handle things like Pod shutdown
in cases where the RTUClient cannot recover. Examples are when reloading Notebook state
after inconsistent_state_event and not getting a current_version_id to subscribe by or
getting Deltas that cannot be squashed into the builder</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">catastrophic_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">    A hook for applications like PA to override so they can handle things like Pod shutdown</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    in cases where the RTUClient cannot recover. Examples are when reloading Notebook state</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">    after inconsistent_state_event and not getting a current_version_id to subscribe by or</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">    getting Deltas that cannot be squashed into the builder</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Catastrophic failure, RTU applications can override this hook&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.change_cell_type" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">change_cell_type</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">code_language</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">db_connection</span><span class="o">=</span><span class="s1">&#39;@noteable&#39;</span><span class="p">,</span> <span class="n">assign_results_to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.change_cell_type" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Switch a cell between code, markdown, or SQL cell.
 - code_language only relevant when switching to code cell
 - db_connection and assign_results_to only relevant when switching to SQL cell</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-875" name="__codelineno-0-875"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">change_cell_type</span><span class="p">(</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>    <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>    <span class="n">cell_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;markdown&quot;</span><span class="p">,</span> <span class="s2">&quot;sql&quot;</span><span class="p">],</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>    <span class="n">code_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>    <span class="n">db_connection</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;@noteable&quot;</span><span class="p">,</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>    <span class="n">assign_results_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a><span class="sd">    Switch a cell between code, markdown, or SQL cell.</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a><span class="sd">     - code_language only relevant when switching to code cell</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a><span class="sd">     - db_connection and assign_results_to only relevant when switching to SQL cell</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>  <span class="c1"># Raise CellNotFound if it doesn&#39;t exist</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>    <span class="k">if</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataReplace</span><span class="p">(</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>            <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>            <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>            <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="n">code_language</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">},</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>        <span class="p">)</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>    <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;markdown&quot;</span><span class="p">:</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataReplace</span><span class="p">(</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>            <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>            <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>            <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;markdown&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;markdown&quot;</span><span class="p">},</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>        <span class="p">)</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>    <span class="k">elif</span> <span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;sql&quot;</span><span class="p">:</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataReplace</span><span class="p">(</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>            <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>            <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>            <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;sql&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;code&quot;</span><span class="p">},</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>        <span class="p">)</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">assign_results_to</span><span class="p">:</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>            <span class="n">name_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a>            <span class="n">assign_results_to</span> <span class="o">=</span> <span class="s2">&quot;df_&quot;</span> <span class="o">+</span> <span class="n">name_suffix</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellMetadataUpdate</span><span class="p">(</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a>            <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a>            <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a>            <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a>                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;noteable&quot;</span><span class="p">],</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>                    <span class="s2">&quot;cell_type&quot;</span><span class="p">:</span> <span class="s2">&quot;sql&quot;</span><span class="p">,</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>                    <span class="s2">&quot;db_connection&quot;</span><span class="p">:</span> <span class="n">db_connection</span><span class="p">,</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>                    <span class="s2">&quot;assign_results_to&quot;</span><span class="p">:</span> <span class="n">assign_results_to</span><span class="p">,</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>                <span class="p">},</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>            <span class="p">},</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>        <span class="p">)</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown cell type </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>    <span class="c1"># Grab updated cell post-squashing</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>    <span class="k">return</span> <span class="n">cell</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.failed_to_squash_delta" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">failed_to_squash_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.failed_to_squash_delta" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Hook for Application code to override when a Delta fails to "squash" into the in-memory
Notebook representation.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-716" name="__codelineno-0-716"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">failed_to_squash_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">    Hook for Application code to override when a Delta fails to &quot;squash&quot; into the in-memory</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a><span class="sd">    Notebook representation.</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.file_unsubscribe" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">file_unsubscribe</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.file_unsubscribe" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Send file unsubscribe request to Gate. This is called when the RTUClient is shutting down.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">file_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">    Send file unsubscribe request to Gate. This is called when the RTUClient is shutting down.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>    <span class="n">req</span> <span class="o">=</span> <span class="n">FileUnsubscribeRequest</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.load_seed_notebook" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">load_seed_notebook</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.load_seed_notebook" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Pull in the seed notebook that will be the base document model of the NotebookBuilder, which
can then squash Deltas that update the Notebook, including deltas_to_apply on file subscribe
which represents changes that may have happened since the last "save" to s3.
 - Get current file version and presigned url from /v1/files endpoint
 - Download and parse seed notebook into Notebook / NotebookBuilder</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">load_seed_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="sd">    Pull in the seed notebook that will be the base document model of the NotebookBuilder, which</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">    can then squash Deltas that update the Notebook, including deltas_to_apply on file subscribe</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">    which represents changes that may have happened since the last &quot;save&quot; to s3.</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">     - Get current file version and presigned url from /v1/files endpoint</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">     - Download and parse seed notebook into Notebook / NotebookBuilder</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="n">file</span><span class="p">:</span> <span class="n">File</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="c1"># Current file version id is used in file subscribe request</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">current_version_id</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gate shows no current version id for File </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">, aborting.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">catastrophic_failure</span><span class="p">()</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">file_version_id</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">current_version_id</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading seed Notebook&quot;</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="c1"># Download seed Notebook and parse into Notebook / NotebookBuilder</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="c1"># TODO: remove this hack if/when we get containers in Skaffold to be able to translate</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="c1"># localhost urls to the minio pod/container -- relevant to Noteable devs only</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="k">if</span> <span class="s2">&quot;LOCAL_K8S&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LOCAL_K8S&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="n">file</span><span class="o">.</span><span class="n">presigned_download_url</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">presigned_download_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;minio&quot;</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">plain_http_client</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">plain_http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">presigned_download_url</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="n">seed_notebook</span> <span class="o">=</span> <span class="n">Notebook</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">NotebookBuilder</span><span class="p">(</span><span class="n">seed_notebook</span><span class="o">=</span><span class="n">seed_notebook</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.new_delta_request" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">FileDelta</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.new_delta_request" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Send a new delta request to the server and wait for it to have been accepted and propogated
to other clients, as well as squashed into our own in-memory Notebook.
Raises errors if the Delta was rejected for any reason.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-837" name="__codelineno-0-837"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">new_delta_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">FileDelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FileDelta</span><span class="p">:</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a><span class="sd">    Send a new delta request to the server and wait for it to have been accepted and propogated</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a><span class="sd">    to other clients, as well as squashed into our own in-memory Notebook.</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a><span class="sd">    Raises errors if the Delta was rejected for any reason.</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>    <span class="n">req</span> <span class="o">=</span> <span class="n">DeltaRequestCallbackManager</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">result</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.on_bulk_cell_state_update" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_bulk_cell_state_update</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.on_bulk_cell_state_update" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Called when we receive a bulk_cell_state_update_event on kernels/ channel</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-797" name="__codelineno-0-797"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">on_bulk_cell_state_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">BulkCellStateUpdateResponse</span><span class="p">):</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Called when we receive a bulk_cell_state_update_event on kernels/ channel&quot;&quot;&quot;</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cell_states</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cell_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">:</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>            <span class="c1"># When we see that a cell we&#39;re monitoring has finished, resolve the Future to</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>            <span class="c1"># be the cell</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;finished_with_error&quot;</span><span class="p">,</span> <span class="s2">&quot;finished_with_no_error&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>                    <span class="s2">&quot;Cell execution for monitored cell finished&quot;</span><span class="p">,</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>                        <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>                    <span class="p">},</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>                <span class="p">)</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>                <span class="n">fut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">]</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                        <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                        <span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                    <span class="k">except</span> <span class="n">CellNotFound</span><span class="p">:</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                        <span class="c1"># This could happen if a cell was deleted in the middle of execution</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>                            <span class="s2">&quot;Cell execution finished for cell that doesn&#39;t exist in Notebook&quot;</span><span class="p">,</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>                                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">,</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>                                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>                            <span class="p">},</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>                        <span class="p">)</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                        <span class="n">fut</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">CellNotFound</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">))</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated cell states&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cell_states&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_states</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.on_file_subscribe_timeout" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_file_subscribe_timeout</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.on_file_subscribe_timeout" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Hook for Application code to override if we don't get the expected file subscribe reply
after some amount of seconds. Without a timeout, RTU Clients can easily get stuck forever
awaiting the .deltas_to_apply event that is resolved in file subscribe reply.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">on_file_subscribe_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">    Hook for Application code to override if we don&#39;t get the expected file subscribe reply</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><span class="sd">    after some amount of seconds. Without a timeout, RTU Clients can easily get stuck forever</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">    awaiting the .deltas_to_apply event that is resolved in file subscribe reply.</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_subcribe_timeout</span><span class="p">)</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;File subscribe timeout reached&quot;</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;File subscribe reply timeout&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.on_inconsistent_state_event" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_inconsistent_state_event</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.on_inconsistent_state_event" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>To "reset" our internal document model, we need to unsubscribe from the files channel at
the least, to stop getting new deltas in. Then we need to figure out what the new current
version id is, and pull down seed notebook, and then resubscribe to file channel.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">on_inconsistent_state_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InconsistentStateEvent</span><span class="p">):</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="sd">    To &quot;reset&quot; our internal document model, we need to unsubscribe from the files channel at</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="sd">    the least, to stop getting new deltas in. Then we need to figure out what the new current</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">    version id is, and pull down seed notebook, and then resubscribe to file channel.</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent_state_event_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Calling catastrophic failure after 3 inconsistent state events&quot;</span><span class="p">)</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">catastrophic_failure</span><span class="p">()</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received inconsistent state event, resetting NotebookBuilder&quot;</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>    <span class="c1"># There&#39;s the chance for some gnarly but rare edge cases here that would probably take a</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>    <span class="c1"># serious amount of thinking and logic to handle. Basically, what happens if new Deltas</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>    <span class="c1"># come in while we&#39;re trying to &quot;reset&quot; the document model after an inconsistent state?</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="c1"># - Can the unsubscribe be handled in Gate after the second subscribe? Unlikely since it&#39;s</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>    <span class="c1">#   the same Gate handling both (websocket, sticky session).</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>    <span class="c1"># - Can Deltas end up coming in out of order, something come over the wire while we&#39;re</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>    <span class="c1">#   in the middle of resetting? Potentially, but that would just end up leading to failure</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>    <span class="c1">#   to apply delta and catastrophic failure, which is effectively what we were doing on</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="c1">#   inconsistent_state_event before adding this method here.</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_unsubscribe</span><span class="p">()</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_seed_notebook</span><span class="p">()</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_file_subscribe</span><span class="p">()</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent_state_event_count</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.on_kernel_status_update" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_kernel_status_update</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.on_kernel_status_update" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Called when we receive a kernel_status_update_event on kernels/ channel</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-792" name="__codelineno-0-792"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">on_kernel_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">KernelStatusUpdateResponse</span><span class="p">):</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Called when we receive a kernel_status_update_event on kernels/ channel&quot;&quot;&quot;</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">execution_state</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;updating Kernel state to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.post_queue_delta" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">post_queue_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.post_queue_delta" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Hook for Application code to override if it wants to do something special when queueing
"out of order" Deltas.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-702" name="__codelineno-0-702"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">post_queue_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="sd">    Hook for Application code to override if it wants to do something special when queueing</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">    &quot;out of order&quot; Deltas.</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.pre_apply_delta" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pre_apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.pre_apply_delta" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Hook for Application code to override if it wants to do something special before running
"squashing" Delta into NotebookBuilder and running applicable callbacks.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">pre_apply_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">    Hook for Application code to override if it wants to do something special before running</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a><span class="sd">    &quot;squashing&quot; Delta into NotebookBuilder and running applicable callbacks.</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.queue_execution" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">queue_execution</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">before_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">after_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.queue_execution" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Execute an individual cell or multiple cells in the Notebook. The return value is a dict of
{future: cell_id}, even in the case of executing a single cell.</p>
<ul>
<li>Only code Cells can be executed. When running multiple cells with before / after / all
   non-code cells will be excluded automatically</li>
<li>Code cells with no source are not executed on Noteable backend, so they'll be skipped</li>
<li>Outputs should be available from the cell.output_collection_id property</li>
</ul>
<p>Use:
queued_execute = await rtu_client.queue_execution(run_all=True)
done, pending = await asyncio.wait(*queued_execute, timeout=5)</p>
<p>still_running_cell_ids = [queued_execute[f] for f in pending]</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">queue_execution</span><span class="p">(</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>    <span class="n">cell_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>    <span class="n">before_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>    <span class="n">after_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>    <span class="n">run_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">CodeCell</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a><span class="sd">    Execute an individual cell or multiple cells in the Notebook. The return value is a dict of</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a><span class="sd">    {future: cell_id}, even in the case of executing a single cell.</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a><span class="sd">     - Only code Cells can be executed. When running multiple cells with before / after / all</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a><span class="sd">       non-code cells will be excluded automatically</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a><span class="sd">     - Code cells with no source are not executed on Noteable backend, so they&#39;ll be skipped</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a><span class="sd">     - Outputs should be available from the cell.output_collection_id property</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a><span class="sd">    Use:</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a><span class="sd">    queued_execute = await rtu_client.queue_execution(run_all=True)</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a><span class="sd">    done, pending = await asyncio.wait(*queued_execute, timeout=5)</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a><span class="sd">    still_running_cell_ids = [queued_execute[f] for f in pending]</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">before_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">after_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_all</span><span class="p">:</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One of cell_id, before_id, after_id, or run_all must be set.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">==</span> <span class="s2">&quot;not_started&quot;</span><span class="p">:</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>            <span class="s2">&quot;Cannot submit cell execution requests for Notebook that has not started a Kernel. Use api_client.launch_kernel to start one.&quot;</span>  <span class="c1"># noqa: E501</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>        <span class="p">)</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>    <span class="k">if</span> <span class="n">cell_id</span><span class="p">:</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>        <span class="n">cell_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell_id</span><span class="p">]</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecute</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>    <span class="k">elif</span> <span class="n">before_id</span><span class="p">:</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>        <span class="n">idx</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">before_id</span><span class="p">)</span>  <span class="c1"># can raise CellNotFound</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[:</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># inclusive of the &quot;before_id&quot; cell</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecuteBefore</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">before_id</span><span class="p">)</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>    <span class="k">elif</span> <span class="n">after_id</span><span class="p">:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>        <span class="n">idx</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">after_id</span><span class="p">)</span>  <span class="c1"># can raise CellNotFound</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>  <span class="c1"># inclusive of the &quot;after_id&quot; cell</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecuteAfter</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">after_id</span><span class="p">)</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">[:]</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>        <span class="n">delta</span> <span class="o">=</span> <span class="n">CellExecuteAll</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>    <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>    <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cell_ids</span><span class="p">:</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>        <span class="c1"># Only create futures for Code cells that have something in source. Otherwise the cell</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>        <span class="c1"># will never get executed by PA/Kernel, so we&#39;d never see cell status and resolve future</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>        <span class="n">idx</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_cell_events</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>            <span class="n">futures</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_id</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>    <span class="k">return</span> <span class="n">futures</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.queue_or_apply_delta" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">queue_or_apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.queue_or_apply_delta" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Checks whether we're able to apply the Delta by comparing its
parent_delta_id with the last_applied_delta_id in the NBBuilder.
If it is not a match, we may have received out of order deltas and we
queue it to be replayed later</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-679" name="__codelineno-0-679"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">queue_or_apply_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">FileDelta</span><span class="p">):</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">    Checks whether we&#39;re able to apply the Delta by comparing its</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="sd">    parent_delta_id with the last_applied_delta_id in the NBBuilder.</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">    If it is not a match, we may have received out of order deltas and we</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a><span class="sd">    queue it to be replayed later</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>        <span class="c1"># We need this for situations where we&#39;ve downloaded the seed notebook and gotten deltas</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>        <span class="c1"># to apply from file subscribe reply, but do not have information about what the first</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="c1"># delta in that deltas-to-apply list is.</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="k">elif</span> <span class="n">delta</span><span class="o">.</span><span class="n">parent_delta_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">:</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>        <span class="c1"># For logging related to applying delta, override .pre_apply_delta</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_unapplied_deltas</span><span class="p">()</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>        <span class="c1"># For logging related to queueing &quot;out of order&quot; Deltas, override .post_queue_delta</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_queue_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.register_delta_callback" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">register_delta_callback</span><span class="p">(</span><span class="n">delta_class</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></code>

<a href="#clients.rtu.RTUClient.register_delta_callback" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Register a callback that may be triggered when we (eventually) apply an in-order Delta.</p>
<p>RTUClient has a separate mechanism for registering delta callbacks from the vanilla
Sending .register_callback flow because we don't necessarily want to run callbacks
immediately when we observe a Delta come over the RTU websocket. We may be dealing
with out-of-order deltas that are queued up and applied later on.</p>
<p>These callbacks are triggered by .apply_delta() and stored in a separate callback
list from vanilla Sending callbacks (manager.register_callback's)</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="k">def</span> <span class="nf">register_delta_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">FileDelta</span><span class="p">],</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">    Register a callback that may be triggered when we (eventually) apply an in-order Delta.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">    RTUClient has a separate mechanism for registering delta callbacks from the vanilla</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">    Sending .register_callback flow because we don&#39;t necessarily want to run callbacks</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">    immediately when we observe a Delta come over the RTU websocket. We may be dealing</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">    with out-of-order deltas that are queued up and applied later on.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a><span class="sd">    These callbacks are triggered by .apply_delta() and stored in a separate callback</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">    list from vanilla Sending callbacks (manager.register_callback&#39;s)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="n">cb</span> <span class="o">=</span> <span class="n">DeltaCallback</span><span class="p">(</span><span class="n">delta_class</span><span class="o">=</span><span class="n">delta_class</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">delta_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="k">return</span> <span class="n">cb</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.register_rtu_event_callback" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">register_rtu_event_callback</span><span class="p">(</span><span class="n">rtu_event</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></code>

<a href="#clients.rtu.RTUClient.register_rtu_event_callback" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Register a callback that will be awaited whenever an RTU event is received that matches the
other arguments passed in (event, channel, channel_prefix, transaction_id).</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="k">def</span> <span class="nf">register_rtu_event_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtu_event</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">RTUResponse</span><span class="p">],</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">    Register a callback that will be awaited whenever an RTU event is received that matches the</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">    other arguments passed in (event, channel, channel_prefix, transaction_id).</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="c1"># When Sending/RTUManager receives and deserializes a message to an RTU event, it checks</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="c1"># every registered callback. If those have a &quot;predicate_fn&quot;, it runs that fn against the</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="c1"># incoming message to decide whether to await the callback.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="c1"># The &quot;topic&quot; in the predicate_fn is always hardcoded to &quot;&quot; in the websocket backend, it&#39;s</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="c1"># used in other backends like redis just not applicable here.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="k">def</span> <span class="nf">predicate_fn</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">rtu_event</span><span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">on_predicate</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.register_transaction_id_callback" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">register_transaction_id_callback</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></code>

<a href="#clients.rtu.RTUClient.register_transaction_id_callback" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Register a callback that will be triggered whenever an RTU message comes in with a given
transaction id. Useful for doing things like waiting for a reply / event or error to be
propogated, e.g. for new delta requests.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="k">def</span> <span class="nf">register_transaction_id_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">    Register a callback that will be triggered whenever an RTU message comes in with a given</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">    transaction id. Useful for doing things like waiting for a reply / event or error to be</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">    propogated, e.g. for new delta requests.</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>    <span class="k">def</span> <span class="nf">predicate_fn</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTUResponse</span><span class="p">):</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">==</span> <span class="n">transaction_id</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">on_predicate</span><span class="o">=</span><span class="n">predicate_fn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.replace_cell_content" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">replace_cell_content</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.replace_cell_content" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Replace cell content with a string</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-945" name="__codelineno-0-945"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">replace_cell_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a><span class="sd">    Replace cell content with a string</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="n">CellContentsReplace</span><span class="p">(</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>        <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">}</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>    <span class="p">)</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>    <span class="c1"># Grab updated cell post-squashing</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>    <span class="k">return</span> <span class="n">cell</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.replay_unapplied_deltas" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">replay_unapplied_deltas</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.replay_unapplied_deltas" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Attempt to apply any previous unapplied Deltas that were received out of order.
Calls itself recursively in case replaying unapplied deltas resulted in multiple
Deltas now being able to be applied. E.g. we received in order:
 - {'id': 2, 'parent_id': 1} # applied because NBBuilder had no last_applied_delta_id
 - {'id': 5, 'parent_id': 4} # queued because parent_id doesn't match builder
 - {'id': 4, 'parent_id': 3} # queued because parent_id doesn't match builder
 - {'id': 3, 'parent_id': 2} # applied, then needs to replay queued deltas</p>
<p>Replaying would make the third received delta be applied, which would let
replaying again also apply the second delta.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-768" name="__codelineno-0-768"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">replay_unapplied_deltas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a><span class="sd">    Attempt to apply any previous unapplied Deltas that were received out of order.</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a><span class="sd">    Calls itself recursively in case replaying unapplied deltas resulted in multiple</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a><span class="sd">    Deltas now being able to be applied. E.g. we received in order:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a><span class="sd">     - {&#39;id&#39;: 2, &#39;parent_id&#39;: 1} # applied because NBBuilder had no last_applied_delta_id</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a><span class="sd">     - {&#39;id&#39;: 5, &#39;parent_id&#39;: 4} # queued because parent_id doesn&#39;t match builder</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a><span class="sd">     - {&#39;id&#39;: 4, &#39;parent_id&#39;: 3} # queued because parent_id doesn&#39;t match builder</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a><span class="sd">     - {&#39;id&#39;: 3, &#39;parent_id&#39;: 2} # applied, then needs to replay queued deltas</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="sd">    Replaying would make the third received delta be applied, which would let</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="sd">    replaying again also apply the second delta.</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>    <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="p">:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">parent_delta_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">:</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>                <span class="s2">&quot;Applying previously queued out of order delta&quot;</span><span class="p">,</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;delta_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="p">)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_delta</span><span class="p">(</span><span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unapplied_deltas</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_unapplied_deltas</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.send" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code>

<a href="#clients.rtu.RTUClient.send" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Send an RTU message to Noteable. This is not async because what's happening behind the
scenes is that RTUManager.send drops the RTU pydantic model onto an "outbound" asyncio.Queue
then the "outbound worker" picks it up off the queue, serializes it to JSON, and sends it
out over the wire.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">RTURequest</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">    Send an RTU message to Noteable. This is not async because what&#39;s happening behind the</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">    scenes is that RTUManager.send drops the RTU pydantic model onto an &quot;outbound&quot; asyncio.Queue</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">    then the &quot;outbound worker&quot; picks it up off the queue, serializes it to JSON, and sends it</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">    out over the wire.</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.send_file_subscribe" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">send_file_subscribe</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.send_file_subscribe" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Once <code>authenticate_reply</code> is observed, we should send the File subscription request.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">send_file_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">    Once `authenticate_reply` is observed, we should send the File subscription request.</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>    <span class="c1"># If our NotebookBuilder hasn&#39;t applied any deltas yet, then we should subscribe</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="c1"># by the version_id. That is, we think we&#39;ve pulled down a clean seed Notebook by</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>    <span class="c1"># s3 version id, and need to get deltas by the matching noteable version id.</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="c1">#</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>    <span class="c1"># However if we&#39;ve started applying deltas, such as after a Gate crash and RTU</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="c1"># reconnect, then subscribe by the last applied delta id.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>    <span class="c1">#</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="c1"># Note this also means file subscribe won&#39;t happen until after we&#39;ve pulled down</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="c1"># the seed notebook from s3 for the first time, which is probably fine.</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="c1">#</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="c1"># Second note, subscribing by delta id all-0&#39;s throws an error in Gate.</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span> <span class="o">!=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># type: ignore # noqa: E501</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>            <span class="s2">&quot;Sending File subscribe request by last applied delta id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;from_delta_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">)},</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="p">)</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="n">FileSubscribeRequestData</span><span class="p">(</span><span class="n">from_delta_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">last_applied_delta_id</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="n">req</span> <span class="o">=</span> <span class="n">FileSubscribeRequest</span><span class="p">(</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>            <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="p">)</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="s2">&quot;Sending File subscribe request by version id&quot;</span><span class="p">,</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;from_version_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_version_id</span><span class="p">)},</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="p">)</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="n">req_data</span> <span class="o">=</span> <span class="n">FileSubscribeRequestData</span><span class="p">(</span><span class="n">from_version_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_version_id</span><span class="p">)</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="n">req</span> <span class="o">=</span> <span class="n">FileSubscribeRequest</span><span class="p">(</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="n">channel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="n">data</span><span class="o">=</span><span class="n">req_data</span><span class="p">,</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="p">)</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">file_subscribe_timeout_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_file_subscribe_timeout</span><span class="p">())</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.update_cell_content" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">update_cell_content</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.update_cell_content" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Update cell content with a diff-match-patch patch string</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-933" name="__codelineno-0-933"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">update_cell_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">patch</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotebookCell</span><span class="p">:</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a><span class="sd">    Update cell content with a diff-match-patch patch string</span>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="n">CellContentsUpdate</span><span class="p">(</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>        <span class="n">file_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">resource_id</span><span class="o">=</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;patch&quot;</span><span class="p">:</span> <span class="n">patch</span><span class="p">}</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>    <span class="p">)</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_delta_request</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>    <span class="c1"># Grab updated cell post-squashing</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>    <span class="k">return</span> <span class="n">cell</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUClient.wait_for_kernel_idle" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">wait_for_kernel_idle</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUClient.wait_for_kernel_idle" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Wait for the kernel to be idle</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-830" name="__codelineno-0-830"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_kernel_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait for the kernel to be idle&quot;&quot;&quot;</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for Kernel to be idle&quot;</span><span class="p">)</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_state</span> <span class="o">!=</span> <span class="s2">&quot;idle&quot;</span><span class="p">:</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Kernel is idle&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="clients.rtu.RTUManager" class="doc doc-heading">
          <code>RTUManager</code>


<a href="#clients.rtu.RTUManager" class="headerlink" title="Permanent link">#</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="sending.backends.websocket.WebsocketManager">WebsocketManager</span></code></p>

  
      <ul>
<li>Makes a connection to the RTU validation server</li>
<li>Handles reconnection if the validation server crashes</li>
<li>Serializes inbound messages to rtu.GenericRTUReply and outbound to rtu.GenericRTURequest</li>
<li>Adds extra logging kwargs for RTU event type and optional Delta type/action</li>
<li>Other classes that use this should add appropriate .auth_hook and .init_hook,
  and register callbacks to do something with RTU events (see RTUClient)</li>
</ul>

            <details class="quote">
              <summary>Source code in <code>origami/clients/rtu.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="k">class</span> <span class="nc">RTUManager</span><span class="p">(</span><span class="n">WebsocketManager</span><span class="p">):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    - Makes a connection to the RTU validation server</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    - Handles reconnection if the validation server crashes</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    - Serializes inbound messages to rtu.GenericRTUReply and outbound to rtu.GenericRTURequest</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    - Adds extra logging kwargs for RTU event type and optional Delta type/action</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    - Other classes that use this should add appropriate .auth_hook and .init_hook,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">      and register callbacks to do something with RTU events (see RTUClient)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="c1"># Serializing inbound and outbound messages between websocket str payloads and RTU models</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">inbound_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RTUResponse</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        Hook applied to every message coming in to us over the websocket before the message</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        is passed to registered callback functions.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">         - The validation server receives RTU Requests and emits RTU Replies</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">         - We&#39;re an RTU client, every message we get should parse into an RTU Reply</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">         - Registered callback functions should expect to take in an RTU Reply pydantic model</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="c1"># Two-pass parsing, once to BaseRTUResponse to generate channel_prefix dervied value</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="c1"># then a second parse to go through the discriminators to a specific event (or fall back</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="c1"># to error or BaseRTUResponse)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;channel_prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">rtu_event</span> <span class="o">=</span> <span class="n">RTUResponseParser</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="c1"># Debug Logging</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">extra_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="s2">&quot;rtu_event&quot;</span><span class="p">:</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">event</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="s2">&quot;rtu_transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">rtu_event</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="s2">&quot;rtu_channel&quot;</span><span class="p">:</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="p">}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rtu_event</span><span class="p">,</span> <span class="n">NewDeltaEvent</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta_type</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta_action</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="se">\n</span><span class="s2">Parsed: </span><span class="si">{</span><span class="n">rtu_event</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">extra_dict</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="k">return</span> <span class="n">rtu_event</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">outbound_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="n">RTURequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        Hook applied to every message we send out over the websocket.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">         - Anything calling .send() should pass in an RTU Request pydantic model</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="k">return</span> <span class="n">contents</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">()</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">RTURequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override WebsocketManager-defined method for type hinting and logging.&quot;&quot;&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="c1"># all this extra stuff is just for logging</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">extra_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="s2">&quot;rtu_event&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">event</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="s2">&quot;rtu_transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="p">}</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;new_delta_request&quot;</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">delta_type</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">delta_action</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending: RTU request&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">extra_dict</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># the .outbound_message_hook handles serializing this to json</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        Add a naive delay in reconnecting if we broke the websocket connection because</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        there was a raised Exception in our _poll_loop, e.g. unserializable messages</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        or syntax errors somewhere in our code.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        TODO: Make this elegant, perhaps a backoff strategy in Sending base.py</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="c1"># Sleep 1 second per number of reconnections we&#39;ve made</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconnections</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUManager.inbound_message_hook" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">inbound_message_hook</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUManager.inbound_message_hook" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Hook applied to every message coming in to us over the websocket before the message
is passed to registered callback functions.</p>
<ul>
<li>The validation server receives RTU Requests and emits RTU Replies</li>
<li>We're an RTU client, every message we get should parse into an RTU Reply</li>
<li>Registered callback functions should expect to take in an RTU Reply pydantic model</li>
</ul>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">inbound_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RTUResponse</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    Hook applied to every message coming in to us over the websocket before the message</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    is passed to registered callback functions.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">     - The validation server receives RTU Requests and emits RTU Replies</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">     - We&#39;re an RTU client, every message we get should parse into an RTU Reply</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">     - Registered callback functions should expect to take in an RTU Reply pydantic model</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="c1"># Two-pass parsing, once to BaseRTUResponse to generate channel_prefix dervied value</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="c1"># then a second parse to go through the discriminators to a specific event (or fall back</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="c1"># to error or BaseRTUResponse)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;channel_prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="n">rtu_event</span> <span class="o">=</span> <span class="n">RTUResponseParser</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="c1"># Debug Logging</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">extra_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="s2">&quot;rtu_event&quot;</span><span class="p">:</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">event</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="s2">&quot;rtu_transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">rtu_event</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="s2">&quot;rtu_channel&quot;</span><span class="p">:</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="p">}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rtu_event</span><span class="p">,</span> <span class="n">NewDeltaEvent</span><span class="p">):</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta_type</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtu_event</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta_action</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="se">\n</span><span class="s2">Parsed: </span><span class="si">{</span><span class="n">rtu_event</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">extra_dict</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="k">return</span> <span class="n">rtu_event</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUManager.on_exception" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUManager.on_exception" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add a naive delay in reconnecting if we broke the websocket connection because
there was a raised Exception in our _poll_loop, e.g. unserializable messages
or syntax errors somewhere in our code.</p>
<p>TODO: Make this elegant, perhaps a backoff strategy in Sending base.py</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">on_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    Add a naive delay in reconnecting if we broke the websocket connection because</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    there was a raised Exception in our _poll_loop, e.g. unserializable messages</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    or syntax errors somewhere in our code.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    TODO: Make this elegant, perhaps a backoff strategy in Sending base.py</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="c1"># Sleep 1 second per number of reconnections we&#39;ve made</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconnections</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUManager.outbound_message_hook" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">outbound_message_hook</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#clients.rtu.RTUManager.outbound_message_hook" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Hook applied to every message we send out over the websocket.
 - Anything calling .send() should pass in an RTU Request pydantic model</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">outbound_message_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="n">RTURequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    Hook applied to every message we send out over the websocket.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">     - Anything calling .send() should pass in an RTU Request pydantic model</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">return</span> <span class="n">contents</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="clients.rtu.RTUManager.send" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></code>

<a href="#clients.rtu.RTUManager.send" class="headerlink" title="Permanent link">#</a></h3>


  <div class="doc doc-contents ">
  
      <p>Override WebsocketManager-defined method for type hinting and logging.</p>

          <details class="quote">
            <summary>Source code in <code>origami/clients/rtu.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">RTURequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Override WebsocketManager-defined method for type hinting and logging.&quot;&quot;&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="c1"># all this extra stuff is just for logging</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">extra_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="s2">&quot;rtu_event&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">event</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="s2">&quot;rtu_transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="p">}</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;new_delta_request&quot;</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">delta_type</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">extra_dict</span><span class="p">[</span><span class="s2">&quot;delta_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">delta_action</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending: RTU request&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">extra_dict</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>  <span class="c1"># the .outbound_message_hook handles serializing this to json</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.sections", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.81fa17fe.min.js"></script>
      
    
  </body>
</html>